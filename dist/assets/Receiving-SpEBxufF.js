import{R as Te,j as e,r as a,a as re,L as D,I as M,S as le,b as de,c as ce,d as oe,e as me,B as $,p as Ze,m as Le,g as Ae,C as J,f as _,h as Z,i as X,k as ie,T as Ee,l as Re,n as V,o as R,q as Qe,s as y}from"./index-Ch5fV0aO.js";import{M as Xe,L as Ye}from"./schemas-D92qbQIR.js";const pe=Te.forwardRef(function({className:m="",...i},o){return e.jsx("textarea",{ref:o,className:`min-h-[80px] w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400 ${m}`,...i})}),es=({className:r="",viewportClassName:m="",children:i,...o})=>e.jsx("div",{className:`relative overflow-hidden ${r}`,...o,children:e.jsx("div",{className:`overflow-auto ${m}`,children:i})}),ss=["Physical Count Discrepancy","System Error Correction","Damaged/Spoiled Inventory","Quality Control Rejection","Inventory Reconciliation","Location Transfer","Other (specify in notes)"];function ts({isOpen:r,onClose:m,layer:i,skuId:o,onConfirm:v}){const[h,p]=a.useState("decrease"),[f,g]=a.useState(0),[k,N]=a.useState(0),[b,Q]=a.useState(""),[A,S]=a.useState(""),[E,O]=a.useState(""),[B,x]=a.useState(""),[u,d]=a.useState({}),[q,L]=a.useState(!1);a.useEffect(()=>{r&&i&&(p("decrease"),g(0),N(i.remaining),Q(""),S(""),O(""),x(`ADJ-${Date.now()}`),d({}))},[r,i]),a.useEffect(()=>{if(i){const j=h==="increase"?f:-f;N(Math.max(0,i.remaining+j))}},[f,h,i]);const ee=()=>{const j={};return f<=0&&(j.adjustmentQty="Adjustment quantity must be greater than 0"),h==="decrease"&&i&&f>i.remaining&&(j.adjustmentQty=`Cannot exceed available quantity (${i.remaining})`),b.trim()||(j.reason="Adjustment reason is required"),b==="Other (specify in notes)"&&!A.trim()&&(j.customReason="Please specify the custom reason"),E.length>500&&(j.notes="Notes cannot exceed 500 characters"),d(j),Object.keys(j).length===0},Ne=async()=>{if(!(!ee()||!i)){L(!0);try{const j=h==="increase"?f:-f,F=b==="Other (specify in notes)"?A:b;await v({layerId:typeof i.id=="string"?i.id:i.id.toString(),quantity:j,reason:F,notes:E.trim()||void 0,reference:B.trim()||void 0}),m()}catch(j){d({general:j.message||"Failed to process adjustment"})}finally{L(!1)}}},se=j=>`$${j.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`;return!r||!i?null:re.createPortal(e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:"Adjust Inventory Layer"}),e.jsx("button",{onClick:m,className:"text-slate-400 hover:text-slate-600 text-xl leading-none","aria-label":"Close",children:"Ã—"})]}),e.jsxs("div",{className:"bg-slate-50 rounded-lg p-4 mb-6",children:[e.jsx("h4",{className:"font-medium text-slate-900 mb-3",children:"Layer Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Layer ID:"}),e.jsx("div",{className:"font-mono text-slate-900",children:i.id})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"SKU:"}),e.jsx("div",{className:"font-medium text-slate-900",children:o})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Current Quantity:"}),e.jsx("div",{className:"font-medium text-slate-900",children:i.remaining})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Unit Cost:"}),e.jsx("div",{className:"font-medium text-slate-900",children:se(i.cost)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Date:"}),e.jsx("div",{className:"text-slate-900",children:typeof i.date=="string"?new Date(i.date).toLocaleDateString():i.date.toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Current Value:"}),e.jsx("div",{className:"font-medium text-slate-900",children:se(i.remaining*i.cost)})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(D,{className:"text-sm font-medium text-slate-700",children:"Adjustment Type"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("label",{className:`flex items-center space-x-3 p-3 border rounded-lg cursor-pointer transition-colors ${h==="increase"?"bg-green-50 border-green-300 text-green-800":"hover:bg-slate-50"}`,children:[e.jsx("input",{type:"radio",name:"adjustmentType",value:"increase",checked:h==="increase",onChange:()=>p("increase"),className:"text-green-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:"Increase"}),e.jsx("div",{className:"text-xs text-slate-500",children:"Add inventory"})]})]}),e.jsxs("label",{className:`flex items-center space-x-3 p-3 border rounded-lg cursor-pointer transition-colors ${h==="decrease"?"bg-red-50 border-red-300 text-red-800":"hover:bg-slate-50"}`,children:[e.jsx("input",{type:"radio",name:"adjustmentType",value:"decrease",checked:h==="decrease",onChange:()=>p("decrease"),className:"text-red-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:"Decrease"}),e.jsx("div",{className:"text-xs text-slate-500",children:"Remove inventory"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"adjustment-qty",className:"text-sm font-medium text-slate-700",children:"Adjustment Quantity"}),e.jsx(M,{id:"adjustment-qty",type:"number",min:"0.01",step:"0.01",max:h==="decrease"?i.remaining:void 0,value:f||"",onChange:j=>{const F=parseFloat(j.target.value)||0;g(F),d(H=>({...H,adjustmentQty:""}))},className:u.adjustmentQty?"border-red-500":"",placeholder:"Enter quantity to adjust"}),u.adjustmentQty&&e.jsx("div",{className:"text-xs text-red-600",children:u.adjustmentQty})]}),f>0&&e.jsx("div",{className:`p-3 rounded-lg border ${h==="increase"?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("span",{className:"text-slate-600",children:"Current Quantity:"}),e.jsx("span",{className:"font-medium",children:i.remaining})]}),e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("span",{className:"text-slate-600",children:"Adjustment:"}),e.jsxs("span",{className:`font-medium ${h==="increase"?"text-green-600":"text-red-600"}`,children:[h==="increase"?"+":"-",f]})]}),e.jsxs("div",{className:"flex justify-between items-center font-medium text-slate-900 pt-1 border-t border-slate-200",children:[e.jsx("span",{children:"New Quantity:"}),e.jsx("span",{children:k})]}),e.jsxs("div",{className:"flex justify-between items-center text-xs text-slate-500 mt-1",children:[e.jsx("span",{children:"Value Impact:"}),e.jsx("span",{children:se((h==="increase"?f:-f)*i.cost)})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"adjustment-reason",className:"text-sm font-medium text-slate-700",children:"Adjustment Reason *"}),e.jsxs(le,{value:b,onValueChange:j=>{Q(j),d(F=>({...F,reason:"",customReason:""}))},children:[e.jsx(de,{className:u.reason?"border-red-500":"",children:e.jsx(ce,{placeholder:"Select adjustment reason..."})}),e.jsx(oe,{children:ss.map(j=>e.jsx(me,{value:j,children:j},j))})]}),u.reason&&e.jsx("div",{className:"text-xs text-red-600",children:u.reason})]}),b==="Other (specify in notes)"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"custom-reason",className:"text-sm font-medium text-slate-700",children:"Custom Reason *"}),e.jsx(M,{id:"custom-reason",value:A,onChange:j=>{S(j.target.value),d(F=>({...F,customReason:""}))},placeholder:"Please specify the reason for this adjustment",className:u.customReason?"border-red-500":""}),u.customReason&&e.jsx("div",{className:"text-xs text-red-600",children:u.customReason})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"adjustment-ref",className:"text-sm font-medium text-slate-700",children:"Reference"}),e.jsx(M,{id:"adjustment-ref",value:B,onChange:j=>x(j.target.value),placeholder:"Optional reference number"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{htmlFor:"adjustment-notes",className:"text-sm font-medium text-slate-700",children:["Notes ",e.jsx("span",{className:"text-slate-400",children:"(Optional)"})]}),e.jsx(pe,{id:"adjustment-notes",value:E,onChange:j=>{O(j.target.value),d(F=>({...F,notes:""}))},placeholder:"Additional notes about this adjustment...",className:`min-h-[80px] ${u.notes?"border-red-500":""}`,maxLength:500}),u.notes&&e.jsx("div",{className:"text-xs text-red-600",children:u.notes}),e.jsxs("div",{className:"text-xs text-slate-500 text-right",children:[E.length,"/500 characters"]})]}),u.general&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700",children:u.general})]}),e.jsxs("div",{className:"flex gap-3 mt-6 pt-4 border-t",children:[e.jsx($,{type:"button",variant:"outline",onClick:m,className:"flex-1",disabled:q,children:"Cancel"}),e.jsx($,{type:"button",onClick:Ne,className:`flex-1 ${h==="increase"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"} text-white`,disabled:q||f<=0,children:q?"Processing...":`Confirm ${h==="increase"?"Increase":"Decrease"}`})]})]})})}),document.body)}const Y=r=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(r),as=r=>{if(!r||!r.trim())return 0;const m=r.replace(/[$,\s]/g,"");if(m==="."||m==="")return 0;const i=parseFloat(m);return isNaN(i)?0:Math.max(0,i)},ns=(r,m=1e3)=>{const i=r.length,o=m-i,v=i>m;return{count:i,remaining:o,isOverLimit:v}};function is(r){const{vendorName:m,date:i,existingRefs:o=[]}=r;if(!m||!i)return"";const v=m.trim().toUpperCase().replace(/[^A-Z0-9\s-]/g,"").split(/\s+/).filter(Boolean).map(k=>k[0]).join("").slice(0,3)||"VEN",h=i.replace(/-/g,""),p=`PS-${v}-BATCH-${h}`,f=(o.filter(k=>k?.startsWith(p)).length||0)+1,g=String(f).padStart(3,"0");return`${p}-${g}`}function rs({isOpen:r,onClose:m,lineId:i,totalQty:o,currentScope:v,currentQty:h,currentNotes:p,onSave:f}){const[g,k]=a.useState(v),[N,b]=a.useState(h),[Q,A]=a.useState(p),[S,E]=a.useState({});a.useEffect(()=>{r&&(k(v),b(h),A(p),E({}))},[r,v,h,p]);const O=()=>{const u={};return g==="PARTIAL"&&(N<=0?u.quantity="Damaged quantity must be greater than 0":N>=o&&(u.quantity="Damaged quantity must be less than total quantity")),Q.length>500&&(u.notes="Notes cannot exceed 500 characters"),E(u),Object.keys(u).length===0},B=()=>{O()&&(f(g,g==="FULL"?o:N,Q),m())},x=u=>{k(u),b(u==="FULL"?o:Math.min(h||1,o-1)),E({})};return r?re.createPortal(e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:"Configure Damage"}),e.jsx("button",{onClick:m,className:"text-slate-400 hover:text-slate-600 text-xl leading-none","aria-label":"Close",children:"Ã—"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(D,{className:"text-sm font-medium text-slate-700",children:"Damage Scope"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-slate-50",children:[e.jsx("input",{type:"radio",name:"damageScope",value:"FULL",checked:g==="FULL",onChange:()=>x("FULL"),className:"text-blue-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:"Full Batch Damaged"}),e.jsxs("div",{className:"text-xs text-slate-500",children:["All ",o," units are damaged"]})]})]}),e.jsxs("label",{className:"flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-slate-50",children:[e.jsx("input",{type:"radio",name:"damageScope",value:"PARTIAL",checked:g==="PARTIAL",onChange:()=>x("PARTIAL"),className:"text-blue-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:"Partial Damage"}),e.jsx("div",{className:"text-xs text-slate-500",children:"Some units are damaged, others are good"})]})]})]})]}),g==="PARTIAL"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"damaged-qty",className:"text-sm font-medium text-slate-700",children:"Damaged Quantity"}),e.jsx(M,{id:"damaged-qty",type:"number",min:"1",max:o-1,value:N||"",onChange:u=>{const d=parseInt(u.target.value)||0;b(d),E(q=>({...q,quantity:""}))},className:S.quantity?"border-red-500":"",placeholder:"Enter damaged quantity"}),S.quantity&&e.jsx("div",{className:"text-xs text-red-600",children:S.quantity}),e.jsxs("div",{className:"text-xs text-slate-500",children:["Received: ",g==="PARTIAL"?o-N:0," units | Damage: ",g==="PARTIAL"?N:o," units"]})]}),g==="FULL"&&e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-3",children:e.jsxs("div",{className:"text-sm text-amber-800",children:[e.jsx("strong",{children:"Full Loss:"})," All ",o," units will be marked as damage. No inventory will be received for this item."]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{htmlFor:"damage-notes",className:"text-sm font-medium text-slate-700",children:["Damage Notes ",e.jsx("span",{className:"text-slate-400",children:"(Optional)"})]}),e.jsx(pe,{id:"damage-notes",value:Q,onChange:u=>{A(u.target.value),E(d=>({...d,notes:""}))},placeholder:"Describe the damage condition...",className:`min-h-[80px] ${S.notes?"border-red-500":""}`,maxLength:500}),S.notes&&e.jsx("div",{className:"text-xs text-red-600",children:S.notes}),e.jsxs("div",{className:"text-xs text-slate-500 text-right",children:[Q.length,"/500 characters"]})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6 pt-4 border-t",children:[e.jsx($,{type:"button",variant:"outline",onClick:m,className:"flex-1",children:"Cancel"}),e.jsx($,{type:"button",onClick:B,className:"flex-1 bg-blue-600 text-white hover:bg-blue-700",children:"Save Changes"})]})]})})}),document.body):null}function ls({value:r,onChange:m,suggestions:i,error:o,id:v}){const[h,p]=a.useState(!1),[f,g]=a.useState(""),k=i.some(N=>N.name===r);return a.useEffect(()=>{!k&&r&&(p(!0),g(r))},[r,k]),h?e.jsxs("div",{className:"flex items-stretch gap-2 h-10",children:[e.jsx(M,{id:v,value:f,onChange:N=>{g(N.target.value),m(N.target.value)},placeholder:"Enter vendor name...",className:`flex-1 h-10 ${o?"border-red-500 focus:ring-red-500":""}`,"aria-invalid":!!o,"aria-describedby":o?`${v}-error`:void 0}),e.jsx($,{type:"button",variant:"outline",size:"sm",onClick:()=>{p(!1),g(""),m("")},className:"h-10 w-10 px-0 flex items-center justify-center shrink-0",title:"Select from list",children:e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]}):e.jsxs("div",{className:"flex items-stretch gap-2 h-10",children:[e.jsxs(le,{value:r,onValueChange:m,children:[e.jsx(de,{id:v,className:`flex-1 h-10 ${o?"border-red-500 focus:ring-red-500":""}`,"aria-invalid":!!o,"aria-describedby":o?`${v}-error`:void 0,children:e.jsx(ce,{placeholder:"Select vendor..."})}),e.jsx(oe,{className:"max-h-64",children:i.map(N=>e.jsx(me,{value:N.name,children:e.jsx("span",{className:"font-medium",children:N.name})},N.name))})]}),e.jsx($,{type:"button",variant:"outline",size:"sm",onClick:()=>{p(!0),g(r)},className:"h-10 w-10 px-0 flex items-center justify-center shrink-0 hover:bg-green-50 hover:border-green-300",title:"Add new vendor",children:e.jsx("svg",{className:"h-4 w-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]})}function ds({skus:r,value:m,onChange:i,placeholder:o,error:v,id:h}){return e.jsxs(le,{value:m,onValueChange:i,children:[e.jsx(de,{id:h,className:`h-10 w-full ${v?"border-red-500 focus:ring-red-500":""}`,"aria-invalid":!!v,"aria-describedby":v?`${h}-error`:void 0,children:e.jsx(ce,{placeholder:o})}),e.jsx(oe,{children:r.map(p=>e.jsxs(me,{value:p.id,children:[p.id," â€” ",p.description]},p.id))})]})}function fe({className:r}){return e.jsx("svg",{className:r,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z"})})}function cs({value:r,onChange:m,error:i,id:o,placeholder:v="$0.00"}){const[h,p]=a.useState(""),[f,g]=a.useState(!1);a.useEffect(()=>{!f&&r>0?p(Y(r)):!f&&r===0&&p("")},[r,f]);const k=Q=>{const A=Q.target.value;p(A);const S=as(A);m(S)},N=()=>{g(!0),r>0&&p(r.toString())},b=()=>{g(!1),r>0?p(Y(r)):p("")};return e.jsx(M,{id:o,type:"text",value:h,onChange:k,onFocus:N,onBlur:b,placeholder:v,className:`h-9 w-full ${i?"border-red-500 focus:ring-red-500":""}`,"aria-invalid":!!i,"aria-describedby":i?`${o}-error`:void 0})}function Fe({className:r}){return e.jsx("svg",{className:r,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"})})}function os({title:r,icon:m,children:i}){return e.jsxs(J,{className:"rounded-xl border border-dashed",children:[e.jsx(_,{className:"py-4",children:e.jsxs(Z,{className:"flex items-center gap-2 text-lg",children:[m,r]})}),e.jsx(X,{children:i})]})}function ms({className:r}){return e.jsx("svg",{className:r,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})}function ws({vendors:r,skus:m,layersBySku:i,movements:o,onUpdateLayers:v,onUpdateSKU:h,onAddMovement:p,onRefreshMovements:f}){const[g,k]=a.useState(""),[N,b]=a.useState([]),[Q,A]=a.useState(!1),[S,E]=a.useState(!1),[O,B]=a.useState({isOpen:!1,layer:null,skuId:""});a.useEffect(()=>{if(!g){b([]);return}(async()=>{A(!0);try{const t=await Ae(g);b(t||[])}catch(t){console.error("Failed to fetch FIFO layers:",t),b([])}finally{A(!1)}})()},[g]);const[x,u]=a.useState([{id:"1",skuId:"",qty:0,unitCost:0,isDamaged:!1,damageScope:"NONE",damagedQty:0,damageNotes:""}]),[d,q]=a.useState({date:new Date().toISOString().split("T")[0],vendor:"",packingSlip:"",globalNotes:""}),[L,ee]=a.useState({isOpen:!1,lineId:null,scope:"PARTIAL",quantity:0,notes:""}),[Ne,se]=a.useState(()=>new Date().toISOString().split("T")[0]),[j,F]=a.useState(""),[H,xs]=a.useState(""),[z,us]=a.useState(0),[ve,hs]=a.useState(0),[gs,js]=a.useState(""),[ye,fs]=a.useState(!1),[ps,Ns]=a.useState(""),[be,vs]=a.useState(""),[xe,ke]=a.useState(!1),[te,W]=a.useState(!1),ue=a.useRef(null),[he,Se]=a.useState([]),T=(s,t="info")=>{const n=`${Date.now()}-${Math.random().toString(36).slice(2,7)}`;Se(c=>[...c,{id:n,message:s,kind:t}]),window.setTimeout(()=>{Se(c=>c.filter(l=>l.id!==n))},4e3)},Pe=a.useCallback(()=>{const s=`${Date.now()}-${Math.random().toString(36).slice(2,7)}`;u(t=>[...t,{id:s,skuId:"",qty:0,unitCost:0,isDamaged:!1,damageScope:"NONE",damagedQty:0,damageNotes:""}])},[]),Me=a.useCallback(s=>{x.length>1&&u(t=>t.filter(n=>n.id!==s))},[x.length]),K=a.useCallback((s,t)=>{u(n=>n.map(c=>c.id===s?{...c,...t}:c))},[]),Ce=a.useCallback(s=>{const t=x.find(n=>n.id===s);!t||t.qty<=0||ee({isOpen:!0,lineId:s,scope:t.damageScope==="NONE"?"PARTIAL":t.damageScope,quantity:t.damagedQty||Math.min(1,t.qty),notes:t.damageNotes||""})},[x]),Oe=a.useCallback(()=>{ee({isOpen:!1,lineId:null,scope:"PARTIAL",quantity:0,notes:""})},[]),Ue=a.useCallback((s,t,n)=>{L.lineId&&K(L.lineId,{isDamaged:!0,damageScope:s,damagedQty:t,damageNotes:n})},[L.lineId,K]),Ve=a.useCallback(s=>{K(s,{isDamaged:!1,damageScope:"NONE",damagedQty:0,damageNotes:""})},[K]),P=a.useCallback(s=>{if(!s.isDamaged||s.damageScope==="NONE")return{receiveQty:s.qty,damageQty:0};if(s.damageScope==="FULL")return{receiveQty:0,damageQty:s.qty};const t=Math.min(s.damagedQty,s.qty);return{receiveQty:Math.max(0,s.qty-t),damageQty:t}},[]);a.useCallback((s,t)=>{q(n=>({...n,[s]:t}))},[]);const[G,we]=a.useState(!1),[Ie,$e]=a.useState([]),[Be,ge]=a.useState(!1),ae=a.useCallback(()=>{const s={};d.vendor.trim()||(s.vendor="Vendor is required"),d.date||(s.date="Date is required"),x.forEach((n,c)=>{n.skuId||(s[`line-${n.id}-sku`]="SKU is required"),n.qty<=0&&(s[`line-${n.id}-qty`]="Quantity must be greater than 0"),n.unitCost<=0&&(s[`line-${n.id}-cost`]="Unit cost must be greater than 0"),n.isDamaged&&(n.damageScope==="PARTIAL"&&(n.damagedQty<=0?s[`line-${n.id}-damage-qty`]="Damaged quantity must be greater than 0":n.damagedQty>=n.qty&&(s[`line-${n.id}-damage-qty`]="Damaged quantity must be less than total quantity")),n.damageNotes&&n.damageNotes.length>500&&(s[`line-${n.id}-damage-notes`]="Damage notes cannot exceed 500 characters"))});const t=x.reduce((n,c)=>(c.skuId&&(n[c.skuId]=(n[c.skuId]||0)+1),n),{});return Object.entries(t).forEach(([n,c])=>{c>1&&x.forEach(l=>{l.skuId===n&&(s[`line-${l.id}-duplicate`]="Duplicate SKU detected")})}),s},[x,d]),Ke=a.useCallback(async()=>{const s=ae();if(Object.keys(s).length>0){T("Please fix validation errors before processing","error");return}we(!0),$e([]);const t=[];try{for(const l of x)try{const{receiveQty:w,damageQty:I}=P(l);if(w>0&&await Ze({skuId:l.skuId,quantity:w,unitCost:l.unitCost,date:new Date(d.date),vendorName:d.vendor,packingSlipNo:d.packingSlip||void 0,notes:d.globalNotes?.trim()||void 0}),I>0){const U=`${d.packingSlip||`BATCH-${Date.now()}`}-DAMAGED`;await Le.createDamageMovement({skuId:l.skuId,quantity:I,unitCost:l.unitCost,date:new Date(d.date),reference:U,notes:l.damageNotes||void 0,generalNotes:d.globalNotes?.trim()||void 0,damageNotes:l.damageNotes||void 0}),p?.({datetime:new Date().toISOString().replace("T"," ").substring(0,16),type:"DAMAGE",skuOrName:l.skuId,qty:-I,value:-(I*l.unitCost),ref:U,notes:l.damageNotes||void 0,generalNotes:d.globalNotes?.trim()||void 0,damageNotes:l.damageNotes||void 0})}t.push({line:l,success:!0});const ne=w>0&&I>0?`received ${w}, damaged ${I}`:w>0?`received ${w}`:`damaged ${I}`;T(`âœ“ ${l.skuId} ${ne}`,"success")}catch(w){t.push({line:l,success:!1,error:w.message||"Processing failed"}),T(`âœ— ${l.skuId} failed: ${w.message}`,"error")}$e(t),ge(!0);const n=t.filter(l=>l.success).length,c=t.length;n===c?(T(`All ${c} items processed successfully!`,"success"),u([{id:"1",skuId:"",qty:0,unitCost:0,isDamaged:!1,damageScope:"NONE",damagedQty:0,damageNotes:""}]),q(l=>({...l,globalNotes:"",packingSlip:""}))):T(`${n}/${c} items processed successfully`,"info"),f&&f()}finally{we(!1)}},[x,d,ae,T,v,h]);a.useEffect(()=>{if(!te)return;const s=ue.current,t=s?.querySelector('[data-modal-initial="true"]'),n=s?.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');(t||n)?.focus();const c=l=>{if(te){if(l.key==="Escape"){l.preventDefault(),W(!1);return}if(l.key==="Tab"){const w=ue.current;if(!w)return;const I=Array.from(w.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(_e=>!_e.hasAttribute("disabled"));if(!I.length)return;const ne=document.activeElement;let U=ne?I.indexOf(ne):-1;l.preventDefault(),l.shiftKey?U=(U-1+I.length)%I.length:U=(U+1)%I.length,I[U]?.focus()}}};return document.addEventListener("keydown",c),()=>document.removeEventListener("keydown",c)},[te]);const[je,ys]=a.useState("NONE"),[De,ze]=a.useState(0),[C,He]=a.useState({});m.find(s=>s.id===H),a.useEffect(()=>{const s=ae();He(s)},[ae]),a.useEffect(()=>{ze(s=>{const t=Math.max(0,z||0);return Math.max(0,Math.min(s||0,t))})},[z]),a.useEffect(()=>{if(xe||!d.vendor.trim()||!d.date||!x.some(c=>c.skuId&&c.qty>0))return;const t=(o||[]).map(c=>c.ref).filter(Boolean),n=is({vendorName:d.vendor,date:d.date,existingRefs:t});n&&n!==d.packingSlip&&q(c=>({...c,packingSlip:n}))},[d.vendor,d.date,x,o,xe]),a.useMemo(()=>ns(be),[be]),a.useMemo(()=>Object.keys(C).length===0&&j.trim().length>=3&&H&&z>0&&ve>0,[C,j,H,z,ve]);const qe=a.useMemo(()=>o?o.filter(s=>s.type==="RECEIVE").sort((s,t)=>new Date(t.datetime).getTime()-new Date(s.datetime).getTime()).slice(0,3):[],[o]),We=a.useCallback((s,t)=>{B({isOpen:!0,layer:s,skuId:t})},[]),Ge=a.useCallback(()=>{B({isOpen:!1,layer:null,skuId:""})},[]),Je=a.useCallback(async s=>{try{await Le.createAdjustmentMovement({skuId:g,layerId:s.layerId,quantity:s.quantity,date:new Date,reference:s.reference,reason:s.reason,notes:s.notes,adjustedBy:"current_user"});const t=await Ae(g);b(t||[]),f&&f();const n=s.quantity>0?"increased":"decreased",c=Math.abs(s.quantity);T(`âœ“ Layer ${s.layerId} ${n} by ${c} units`,"success")}catch(t){throw console.error("Error creating adjustment:",t),T(`âœ— Adjustment failed: ${t.message}`,"error"),t}},[g,f,T]);a.useMemo(()=>{const s=Math.max(0,z||0);if(!ye||je==="NONE")return{acceptQty:s,damageQty:0};if(je==="FULL")return{acceptQty:0,damageQty:s};const t=Math.max(0,Math.min(De||0,s));return{acceptQty:Math.max(0,s-t),damageQty:t}},[ye,je,z,De]);const[bs,ks]=a.useState(!1);return e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsx("div",{className:"sr-only","aria-live":"polite",children:he.slice(-1).map(s=>e.jsx("span",{children:s.message},s.id))}),he.length>0&&e.jsx("div",{className:"fixed bottom-4 right-4 z-[60] space-y-2",children:he.map(s=>e.jsx("div",{role:"status",className:`rounded-lg shadow-lg px-3 py-2 text-sm ring-1 ${s.kind==="error"?"bg-red-600 text-white ring-red-700":s.kind==="success"?"bg-emerald-600 text-white ring-emerald-700":"bg-slate-800 text-white ring-slate-900"}`,children:s.message},s.id))}),e.jsxs(J,{className:"max-w-7xl mx-auto",children:[e.jsx(_,{children:e.jsxs(Z,{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"h-5 w-5 text-slate-500"}),"Multi-SKU Receiving Form"]})}),e.jsxs(X,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"bg-slate-50 rounded-lg p-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-900 mb-4",children:"Batch Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-4",children:[e.jsxs("div",{className:"md:col-span-3",children:[e.jsx(D,{htmlFor:"shared-date",className:"text-sm font-medium text-slate-700 block mb-2",children:"Date"}),e.jsx(M,{id:"shared-date",type:"date",value:d.date,onChange:s=>q(t=>({...t,date:s.target.value})),className:"h-10 w-full"}),e.jsx("div",{className:"h-5 mt-1"})]}),e.jsxs("div",{className:"md:col-span-5",children:[e.jsx(D,{htmlFor:"shared-vendor",className:"text-sm font-medium text-slate-700 block mb-2",children:"Vendor *"}),e.jsx(ls,{id:"shared-vendor",value:d.vendor,onChange:s=>q(t=>({...t,vendor:s})),suggestions:r,error:C.vendor}),e.jsx("div",{className:"h-5 mt-1",children:C.vendor&&e.jsx("span",{className:"text-xs text-red-600",children:C.vendor})})]}),e.jsxs("div",{className:"md:col-span-4",children:[e.jsx(D,{htmlFor:"shared-packing-slip",className:"text-sm font-medium text-slate-700 block mb-2",children:"Packing Slip"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"shared-packing-slip",value:d.packingSlip,onChange:s=>{q(t=>({...t,packingSlip:s.target.value})),ke(!0)},onFocus:()=>{d.packingSlip||ke(!1)},className:"h-10 w-full pr-12",placeholder:"Auto after Vendor & SKU & Qty"}),!xe&&d.packingSlip&&e.jsx("div",{className:"absolute right-2 top-1/2 -translate-y-1/2",children:e.jsx(ie,{variant:"secondary",className:"text-xs px-1.5 py-0.5",children:"Auto"})})]}),e.jsx("div",{className:"h-5 mt-1"})]})]})]}),e.jsxs("div",{className:"bg-white border rounded-lg p-4",children:[e.jsx(D,{htmlFor:"shared-notes",className:"text-sm font-medium text-slate-700 block mb-2",children:"Global Notes"}),e.jsx(pe,{id:"shared-notes",value:d.globalNotes,onChange:s=>q(t=>({...t,globalNotes:s.target.value})),placeholder:"Optional notes that will be applied to all items in this batch...",className:"min-h-[80px] resize-none"}),e.jsx("p",{className:"text-xs text-slate-500 mt-2",children:"These notes will be saved with each item in this receiving batch."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-900",children:"Receiving Items"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Add multiple SKUs to process in this batch"})]}),e.jsxs($,{type:"button",variant:"outline",size:"sm",onClick:Pe,className:"text-green-700 border-green-300 hover:bg-green-50 hover:border-green-400 transition-colors",children:[e.jsx(ms,{className:"h-4 w-4 mr-2"}),"Add Item"]})]}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"grid gap-2 sm:gap-3",style:{gridTemplateColumns:"3fr 1fr 1fr 1.5fr 0.5fr"},children:[e.jsx("div",{className:"bg-slate-50 border-b px-3 py-3 text-sm font-medium text-slate-700",children:"SKU"}),e.jsx("div",{className:"bg-slate-50 border-b px-2 py-3 text-sm font-medium text-slate-700",children:"Quantity"}),e.jsx("div",{className:"bg-slate-50 border-b px-2 py-3 text-sm font-medium text-slate-700",children:"Unit Cost"}),e.jsx("div",{className:"bg-slate-50 border-b px-2 py-3 text-sm font-medium text-slate-700",children:"Damage Status"}),e.jsx("div",{className:"bg-slate-50 border-b px-1 py-3 text-sm font-medium text-slate-700 text-center",children:"Actions"}),x.map((s,t)=>{const c=Object.keys(C).filter(l=>l.startsWith(`line-${s.id}`)).length>0;return e.jsxs(Te.Fragment,{children:[e.jsx("div",{className:`px-3 py-3 min-h-[60px] ${c?"bg-red-50":""} ${t>0?"border-t":""}`,children:e.jsxs("div",{className:"space-y-1",children:[e.jsx(ds,{id:`sku-${s.id}`,skus:m,value:s.skuId,onChange:l=>K(s.id,{skuId:l}),placeholder:"Select SKU",error:C[`line-${s.id}-sku`]}),C[`line-${s.id}-sku`]&&e.jsxs("div",{className:"text-xs text-red-600 flex items-start gap-1 min-h-[16px] leading-tight",children:[e.jsx(fe,{className:"h-3 w-3 shrink-0 mt-0.5"}),e.jsx("span",{className:"break-words",children:C[`line-${s.id}-sku`]})]})]})}),e.jsx("div",{className:`px-2 py-3 min-h-[60px] ${c?"bg-red-50":""} ${t>0?"border-t":""}`,children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(M,{id:`qty-${s.id}`,type:"number",step:"any",min:"0",value:s.qty||"",onChange:l=>{const w=Number.isNaN(parseFloat(l.target.value))?0:parseFloat(l.target.value);K(s.id,{qty:Math.max(0,w)})},className:`h-9 w-full min-w-0 ${C[`line-${s.id}-qty`]?"border-red-500":""}`,placeholder:"0"}),e.jsx("span",{className:"text-xs text-slate-500 min-w-[20px] text-center flex-shrink-0",children:s.skuId&&m.find(l=>l.id===s.skuId)?.unit||""})]}),C[`line-${s.id}-qty`]&&e.jsxs("div",{className:"text-xs text-red-600 flex items-start gap-1 min-h-[16px] leading-tight",children:[e.jsx(fe,{className:"h-3 w-3 shrink-0 mt-0.5"}),e.jsx("span",{className:"break-words",children:C[`line-${s.id}-qty`]})]})]})}),e.jsx("div",{className:`px-2 py-3 min-h-[60px] ${c?"bg-red-50":""} ${t>0?"border-t":""}`,children:e.jsxs("div",{className:"space-y-1",children:[e.jsx(cs,{id:`cost-${s.id}`,value:s.unitCost,onChange:l=>K(s.id,{unitCost:l}),error:C[`line-${s.id}-cost`],placeholder:"$0.00"}),C[`line-${s.id}-cost`]&&e.jsxs("div",{className:"text-xs text-red-600 flex items-start gap-1 min-h-[16px] leading-tight",children:[e.jsx(fe,{className:"h-3 w-3 shrink-0 mt-0.5"}),e.jsx("span",{className:"break-words",children:C[`line-${s.id}-cost`]})]})]})}),e.jsx("div",{className:`px-2 py-3 min-h-[60px] ${c?"bg-red-50":""} ${t>0?"border-t":""}`,children:e.jsxs("div",{className:"flex flex-col gap-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("input",{type:"checkbox",id:`damage-${s.id}`,checked:s.isDamaged,onChange:l=>{l.target.checked?Ce(s.id):Ve(s.id)},className:"rounded w-3 h-3",disabled:!s.skuId||s.qty<=0}),e.jsx(D,{htmlFor:`damage-${s.id}`,className:"text-xs cursor-pointer leading-tight",children:"Damaged"})]}),s.isDamaged&&e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1 flex-wrap",children:[s.damageScope==="FULL"?e.jsx(ie,{variant:"destructive",className:"text-xs px-1 py-0 h-5",children:"Full"}):e.jsxs(ie,{variant:"secondary",className:"text-xs px-1 py-0 h-5",children:[s.damagedQty,"/",s.qty]}),e.jsx("button",{type:"button",onClick:()=>Ce(s.id),className:"text-blue-600 hover:text-blue-800 text-xs underline leading-tight",children:"Edit"})]}),s.damageNotes&&e.jsx("div",{className:"text-slate-500 text-xs truncate leading-tight",title:s.damageNotes,children:s.damageNotes})]})]})}),e.jsx("div",{className:`px-1 py-3 min-h-[60px] ${c?"bg-red-50":""} ${t>0?"border-t":""} flex justify-center items-start pt-6`,children:e.jsx($,{type:"button",variant:"outline",size:"sm",onClick:()=>Me(s.id),disabled:x.length<=1,className:"text-red-600 border-red-200 hover:bg-red-50 h-8 w-8 p-0 min-w-8",children:e.jsx(Xe,{className:"h-3 w-3"})})})]},s.id)})]})})}),e.jsx("div",{className:"bg-slate-50 p-3 rounded-lg text-sm",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-xs",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Total Items:"}),e.jsx("span",{className:"font-medium",children:x.filter(s=>s.skuId&&s.qty>0).length})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Total Quantity:"}),e.jsx("span",{className:"font-medium",children:x.filter(s=>s.skuId&&s.qty>0).reduce((s,t)=>s+t.qty,0).toLocaleString()})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-600",children:"Total Value:"}),e.jsxs("span",{className:"font-medium",children:["$",x.filter(s=>s.skuId&&s.qty>0).reduce((s,t)=>s+t.qty*t.unitCost,0).toFixed(2)]})]})]}),e.jsxs("div",{className:"space-y-1 border-l pl-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-green-600",children:"To Inventory:"}),e.jsx("span",{className:"font-medium text-green-600",children:x.filter(s=>s.skuId&&s.qty>0).reduce((s,t)=>s+P(t).receiveQty,0).toLocaleString()})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-red-600",children:"Damage:"}),e.jsx("span",{className:"font-medium text-red-600",children:x.filter(s=>s.skuId&&s.qty>0).reduce((s,t)=>s+P(t).damageQty,0).toLocaleString()})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-green-600",children:"Effective Value:"}),e.jsxs("span",{className:"font-medium text-green-600",children:["$",x.filter(s=>s.skuId&&s.qty>0).reduce((s,t)=>{const{receiveQty:n}=P(t);return s+n*t.unitCost},0).toFixed(2)]})]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between pt-4",children:[e.jsx("div",{className:"text-sm text-slate-500",children:G&&"Processing items..."}),e.jsx("div",{className:"flex gap-2",children:e.jsx($,{type:"button",variant:"outline",onClick:()=>W(!0),disabled:G||x.filter(s=>s.skuId&&s.qty>0).length===0,className:"bg-blue-600 text-white hover:bg-blue-700",children:G?"Processing...":`Process ${x.filter(s=>s.skuId&&s.qty>0).length} Items`})})]})]})]}),te&&re.createPortal(e.jsxs("div",{className:"fixed inset-0 z-50",role:"presentation",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30","aria-hidden":"true",onClick:()=>W(!1)}),e.jsx("div",{className:"absolute left-1/2 top-24 -translate-x-1/2 w-[min(100%,640px)]",role:"dialog","aria-modal":"true","aria-labelledby":"confirm-batch-title",ref:ue,children:e.jsxs(J,{className:"rounded-2xl shadow-2xl bg-white ring-1 ring-black/10",children:[e.jsx(_,{children:e.jsx(Z,{id:"confirm-batch-title",children:"Confirm Multi-SKU Receiving"})}),e.jsxs(X,{className:"space-y-4",children:[e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-700",children:"Date:"})," ",d.date]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-700",children:"Vendor:"})," ",d.vendor||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-700",children:"Packing Slip:"})," ",d.packingSlip||"-"]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"font-medium text-sm",children:["Items to Process (",x.filter(s=>s.skuId&&s.qty>0).length,"):"]}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(Ee,{children:[e.jsx(Re,{children:e.jsxs(V,{className:"bg-slate-50",children:[e.jsx(R,{className:"text-xs",children:"SKU"}),e.jsx(R,{className:"text-xs text-right",children:"Total Qty"}),e.jsx(R,{className:"text-xs text-right text-green-700",children:"To Inventory"}),e.jsx(R,{className:"text-xs text-right text-red-700",children:"Damage"}),e.jsx(R,{className:"text-xs text-right",children:"Cost"}),e.jsx(R,{className:"text-xs text-right text-green-700",children:"Effective Value"})]})}),e.jsxs(Qe,{children:[x.filter(s=>s.skuId&&s.qty>0).map(s=>{const{receiveQty:t,damageQty:n}=P(s);return e.jsxs(V,{className:"text-xs",children:[e.jsx(y,{children:s.skuId}),e.jsx(y,{className:"text-right",children:s.qty}),e.jsx(y,{className:"text-right text-green-700 font-medium",children:t}),e.jsx(y,{className:"text-right text-red-700",children:n}),e.jsxs(y,{className:"text-right",children:["$",s.unitCost.toFixed(2)]}),e.jsxs(y,{className:"text-right text-green-700 font-medium",children:["$",(t*s.unitCost).toFixed(2)]})]},s.id)}),e.jsxs(V,{className:"bg-slate-50 font-medium text-xs",children:[e.jsx(y,{children:"Total"}),e.jsx(y,{className:"text-right",children:x.filter(s=>s.skuId&&s.qty>0).reduce((s,t)=>s+t.qty,0)}),e.jsx(y,{className:"text-right text-green-700",children:x.filter(s=>s.skuId&&s.qty>0).reduce((s,t)=>s+P(t).receiveQty,0)}),e.jsx(y,{className:"text-right text-red-700",children:x.filter(s=>s.skuId&&s.qty>0).reduce((s,t)=>s+P(t).damageQty,0)}),e.jsx(y,{}),e.jsxs(y,{className:"text-right text-green-700",children:["$",x.filter(s=>s.skuId&&s.qty>0).reduce((s,t)=>{const{receiveQty:n}=P(t);return s+n*t.unitCost},0).toFixed(2)]})]})]})]})})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx($,{variant:"outline",onClick:()=>W(!1),"data-modal-initial":"true",children:"Cancel"}),e.jsx($,{onClick:()=>{W(!1),Ke()},disabled:G,children:G?"Processing...":"Confirm & Process All"})]})]})]})})]}),document.body),Be&&Ie.length>0&&re.createPortal(e.jsxs("div",{className:"fixed inset-0 z-50",role:"presentation",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30","aria-hidden":"true",onClick:()=>ge(!1)}),e.jsx("div",{className:"absolute left-1/2 top-24 -translate-x-1/2 w-[min(100%,640px)]",role:"dialog","aria-modal":"true","aria-labelledby":"batch-results-title",children:e.jsxs(J,{className:"rounded-2xl shadow-2xl bg-white ring-1 ring-black/10",children:[e.jsx(_,{children:e.jsx(Z,{id:"batch-results-title",children:"Processing Results"})}),e.jsxs(X,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2",children:Ie.map((s,t)=>e.jsxs("div",{className:`flex items-center gap-3 p-3 rounded-lg text-sm ${s.success?"bg-green-50 text-green-800":"bg-red-50 text-red-800"}`,children:[e.jsx("span",{className:`w-5 h-5 rounded-full flex items-center justify-center text-xs ${s.success?"bg-green-600 text-white":"bg-red-600 text-white"}`,children:s.success?"âœ“":"âœ—"}),e.jsxs("span",{className:"flex-1",children:[e.jsx("strong",{children:s.line.skuId})," - ",(()=>{const{receiveQty:n,damageQty:c}=P(s.line);return n>0&&c>0?`${n} received, ${c} damaged`:n>0?`${n} units received`:`${c} units damaged (full loss)`})(),s.error&&e.jsxs("div",{className:"text-xs mt-1",children:["Error: ",s.error]})]})]},s.line.id))}),e.jsx("div",{className:"flex justify-end gap-2 pt-2",children:e.jsx($,{onClick:()=>ge(!1),children:"Close"})})]})]})})]}),document.body)]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(J,{className:"rounded-xl border border-dashed",children:[e.jsx(_,{className:"py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Z,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ye,{className:"h-5 w-5 text-slate-500"}),"Inventory Layers (FIFO)"]}),e.jsx("div",{className:"w-1/2",children:e.jsxs(le,{value:g,onValueChange:k,children:[e.jsx(de,{placeholder:"Select a SKU...",children:e.jsx(ce,{})}),e.jsx(oe,{children:m.map(s=>e.jsxs(me,{value:s.id,children:[s.id," â€” ",s.description]},s.id))})]})})]})}),e.jsxs(X,{children:[e.jsx(es,{className:"h-[300px] pr-4",children:e.jsxs(Ee,{children:[e.jsx(Re,{children:e.jsxs(V,{children:[e.jsx(R,{children:"Layer ID"}),e.jsx(R,{children:"Date"}),e.jsx(R,{children:"Remaining qty"}),e.jsx(R,{children:"Unit cost"}),e.jsx(R,{children:"Asset Value"}),e.jsx(R,{className:"w-32",children:"Actions"})]})}),e.jsx(Qe,{children:Q?e.jsx(V,{children:e.jsx(y,{colSpan:6,className:"text-center text-sm text-slate-500",children:"Loading layers..."})}):g?N.filter(s=>s.remaining>0).length===0?e.jsx(V,{children:e.jsx(y,{colSpan:6,className:"text-center text-sm text-slate-500",children:"No active layers found for the selected SKU."})}):(S?N.filter(s=>s.remaining>0):N.filter(s=>s.remaining>0).slice(0,10)).map(s=>e.jsxs(V,{className:"hover:bg-slate-50",children:[e.jsx(y,{className:"font-mono text-xs",children:s.id}),e.jsx(y,{children:typeof s.date=="string"?s.date:new Date(s.date).toLocaleDateString()}),e.jsx(y,{className:"font-medium",children:s.remaining}),e.jsx(y,{children:Y(s.cost)}),e.jsx(y,{className:"font-medium",children:Y(s.remaining*s.cost)}),e.jsx(y,{children:e.jsx($,{size:"sm",variant:"outline",onClick:()=>We(s,g),className:"h-7 px-2 text-xs bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100 hover:border-blue-300",title:`Adjust layer ${s.id}`,children:"Adjust"})})]},s.id)):e.jsx(V,{children:e.jsx(y,{colSpan:6,className:"text-center text-sm text-slate-500",children:"Select a SKU to view its layers."})})})]})}),N.filter(s=>s.remaining>0).length>10&&e.jsx("div",{className:"mt-2 text-center",children:e.jsx($,{variant:"link",onClick:()=>E(!S),children:S?"Show less":`View all ${N.filter(s=>s.remaining>0).length} layers`})})]})]})}),e.jsx("div",{className:"space-y-4",children:e.jsx(os,{title:"Recent submissions",icon:e.jsx(Fe,{className:"h-5 w-5 text-slate-500"}),children:e.jsxs("div",{className:"space-y-2",children:[qe.map((s,t)=>e.jsxs("div",{className:"p-3 rounded-xl border border-dashed",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm",children:[s.ref," â€” ",s.skuOrName]}),e.jsx(ie,{variant:"secondary",children:"RECEIVED"})]}),e.jsxs("p",{className:"text-xs text-slate-500",children:[new Date(s.datetime).toLocaleDateString()," â€¢ ",s.qty," units â€¢ ",Y(s.value)]})]},`${s.datetime}-${t}`)),qe.length===0&&e.jsx("div",{className:"p-3 rounded-xl border border-dashed",children:e.jsx("p",{className:"text-sm text-slate-500",children:"No recent submissions."})})]})})})]}),e.jsx(rs,{isOpen:L.isOpen,onClose:Oe,lineId:L.lineId,totalQty:L.lineId&&x.find(s=>s.id===L.lineId)?.qty||0,currentScope:L.scope,currentQty:L.quantity,currentNotes:L.notes,onSave:Ue}),e.jsx(ts,{isOpen:O.isOpen,onClose:Ge,layer:O.layer,skuId:O.skuId,onConfirm:Je})]})}export{ws as default};
