import{r as d,a as He,j as e,I as $,e as C,M as y,t as Ke,C as X,b as Z,c as ee,S as te,l as se,m as ne,n as ie,o as N,d as le,T as Je,f as Ye,g as q,h as F,i as Qe,k as I,B as Ge}from"./index-BKRk5lZ_.js";import{u as Xe}from"./workOrderEvents-Be-RnPcv.js";function V(r,o,t){let s=t.initialDeps??[],n;function i(){var l,a,u,f;let h;t.key&&((l=t.debug)!=null&&l.call(t))&&(h=Date.now());const j=r();if(!(j.length!==s.length||j.some((x,T)=>s[T]!==x)))return n;s=j;let M;if(t.key&&((a=t.debug)!=null&&a.call(t))&&(M=Date.now()),n=o(...j),t.key&&((u=t.debug)!=null&&u.call(t))){const x=Math.round((Date.now()-h)*100)/100,T=Math.round((Date.now()-M)*100)/100,w=T/16,S=(g,L)=>{for(g=String(g);g.length<L;)g=" "+g;return g};console.info(`%c⏱ ${S(T,5)} /${S(x,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*w,120))}deg 100% 31%);`,t?.key)}return(f=t?.onChange)==null||f.call(t,n),n}return i.updateDeps=l=>{s=l},i}function we(r,o){if(r===void 0)throw new Error("Unexpected undefined");return r}const Ze=(r,o)=>Math.abs(r-o)<1.01,et=(r,o,t)=>{let s;return function(...n){r.clearTimeout(s),s=r.setTimeout(()=>o.apply(this,n),t)}},Se=r=>{const{offsetWidth:o,offsetHeight:t}=r;return{width:o,height:t}},tt=r=>r,st=r=>{const o=Math.max(r.startIndex-r.overscan,0),t=Math.min(r.endIndex+r.overscan,r.count-1),s=[];for(let n=o;n<=t;n++)s.push(n);return s},nt=(r,o)=>{const t=r.scrollElement;if(!t)return;const s=r.targetWindow;if(!s)return;const n=l=>{const{width:a,height:u}=l;o({width:Math.round(a),height:Math.round(u)})};if(n(Se(t)),!s.ResizeObserver)return()=>{};const i=new s.ResizeObserver(l=>{const a=()=>{const u=l[0];if(u?.borderBoxSize){const f=u.borderBoxSize[0];if(f){n({width:f.inlineSize,height:f.blockSize});return}}n(Se(t))};r.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(a):a()});return i.observe(t,{box:"border-box"}),()=>{i.unobserve(t)}},Ce={passive:!0},Ee=typeof window>"u"?!0:"onscrollend"in window,it=(r,o)=>{const t=r.scrollElement;if(!t)return;const s=r.targetWindow;if(!s)return;let n=0;const i=r.options.useScrollendEvent&&Ee?()=>{}:et(s,()=>{o(n,!1)},r.options.isScrollingResetDelay),l=h=>()=>{const{horizontal:j,isRtl:p}=r.options;n=j?t.scrollLeft*(p&&-1||1):t.scrollTop,i(),o(n,h)},a=l(!0),u=l(!1);u(),t.addEventListener("scroll",a,Ce);const f=r.options.useScrollendEvent&&Ee;return f&&t.addEventListener("scrollend",u,Ce),()=>{t.removeEventListener("scroll",a),f&&t.removeEventListener("scrollend",u)}},lt=(r,o,t)=>{if(o?.borderBoxSize){const s=o.borderBoxSize[0];if(s)return Math.round(s[t.options.horizontal?"inlineSize":"blockSize"])}return r[t.options.horizontal?"offsetWidth":"offsetHeight"]},rt=(r,{adjustments:o=0,behavior:t},s)=>{var n,i;const l=r+o;(i=(n=s.scrollElement)==null?void 0:n.scrollTo)==null||i.call(n,{[s.options.horizontal?"left":"top"]:l,behavior:t})};class at{constructor(o){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let t=null;const s=()=>t||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:t=new this.targetWindow.ResizeObserver(n=>{n.forEach(i=>{const l=()=>{this._measureElement(i.target,i)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(l):l()})}));return{disconnect:()=>{var n;(n=s())==null||n.disconnect(),t=null},observe:n=>{var i;return(i=s())==null?void 0:i.observe(n,{box:"border-box"})},unobserve:n=>{var i;return(i=s())==null?void 0:i.unobserve(n)}}})(),this.range=null,this.setOptions=t=>{Object.entries(t).forEach(([s,n])=>{typeof n>"u"&&delete t[s]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:tt,rangeExtractor:st,onChange:()=>{},measureElement:lt,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...t}},this.notify=t=>{var s,n;(n=(s=this.options).onChange)==null||n.call(s,this,t)},this.maybeNotify=V(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),t=>{this.notify(t)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(t=>t()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var t;const s=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==s){if(this.cleanup(),!s){this.maybeNotify();return}this.scrollElement=s,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((t=this.scrollElement)==null?void 0:t.window)??null,this.elementsCache.forEach(n=>{this.observer.observe(n)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,n=>{this.scrollRect=n,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(n,i)=>{this.scrollAdjustments=0,this.scrollDirection=i?this.getScrollOffset()<n?"forward":"backward":null,this.scrollOffset=n,this.isScrolling=i,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(t,s)=>{const n=new Map,i=new Map;for(let l=s-1;l>=0;l--){const a=t[l];if(n.has(a.lane))continue;const u=i.get(a.lane);if(u==null||a.end>u.end?i.set(a.lane,a):a.end<u.end&&n.set(a.lane,!0),n.size===this.options.lanes)break}return i.size===this.options.lanes?Array.from(i.values()).sort((l,a)=>l.end===a.end?l.index-a.index:l.end-a.end)[0]:void 0},this.getMeasurementOptions=V(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(t,s,n,i,l)=>(this.pendingMeasuredCacheIndexes=[],{count:t,paddingStart:s,scrollMargin:n,getItemKey:i,enabled:l}),{key:!1}),this.getMeasurements=V(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:t,paddingStart:s,scrollMargin:n,getItemKey:i,enabled:l},a)=>{if(!l)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(h=>{this.itemSizeCache.set(h.key,h.size)}));const u=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const f=this.measurementsCache.slice(0,u);for(let h=u;h<t;h++){const j=i(h),p=this.options.lanes===1?f[h-1]:this.getFurthestMeasurement(f,h),M=p?p.end+this.options.gap:s+n,x=a.get(j),T=typeof x=="number"?x:this.options.estimateSize(h),w=M+T,S=p?p.lane:h%this.options.lanes;f[h]={index:h,start:M,size:T,end:w,key:j,lane:S}}return this.measurementsCache=f,f},{key:!1,debug:()=>this.options.debug}),this.calculateRange=V(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(t,s,n,i)=>this.range=t.length>0&&s>0?ot({measurements:t,outerSize:s,scrollOffset:n,lanes:i}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=V(()=>{let t=null,s=null;const n=this.calculateRange();return n&&(t=n.startIndex,s=n.endIndex),this.maybeNotify.updateDeps([this.isScrolling,t,s]),[this.options.rangeExtractor,this.options.overscan,this.options.count,t,s]},(t,s,n,i,l)=>i===null||l===null?[]:t({startIndex:i,endIndex:l,overscan:s,count:n}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=t=>{const s=this.options.indexAttribute,n=t.getAttribute(s);return n?parseInt(n,10):(console.warn(`Missing attribute name '${s}={index}' on measured element.`),-1)},this._measureElement=(t,s)=>{const n=this.indexFromElement(t),i=this.measurementsCache[n];if(!i)return;const l=i.key,a=this.elementsCache.get(l);a!==t&&(a&&this.observer.unobserve(a),this.observer.observe(t),this.elementsCache.set(l,t)),t.isConnected&&this.resizeItem(n,this.options.measureElement(t,s,this))},this.resizeItem=(t,s)=>{const n=this.measurementsCache[t];if(!n)return;const i=this.itemSizeCache.get(n.key)??n.size,l=s-i;l!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(n,l,this):n.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=l,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(n.index),this.itemSizeCache=new Map(this.itemSizeCache.set(n.key,s)),this.notify(!1))},this.measureElement=t=>{if(!t){this.elementsCache.forEach((s,n)=>{s.isConnected||(this.observer.unobserve(s),this.elementsCache.delete(n))});return}this._measureElement(t,void 0)},this.getVirtualItems=V(()=>[this.getVirtualIndexes(),this.getMeasurements()],(t,s)=>{const n=[];for(let i=0,l=t.length;i<l;i++){const a=t[i],u=s[a];n.push(u)}return n},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=t=>{const s=this.getMeasurements();if(s.length!==0)return we(s[Te(0,s.length-1,n=>we(s[n]).start,t)])},this.getOffsetForAlignment=(t,s,n=0)=>{const i=this.getSize(),l=this.getScrollOffset();s==="auto"&&(s=t>=l+i?"end":"start"),s==="center"?t+=(n-i)/2:s==="end"&&(t-=i);const a=this.getTotalSize()+this.options.scrollMargin-i;return Math.max(Math.min(a,t),0)},this.getOffsetForIndex=(t,s="auto")=>{t=Math.max(0,Math.min(t,this.options.count-1));const n=this.measurementsCache[t];if(!n)return;const i=this.getSize(),l=this.getScrollOffset();if(s==="auto")if(n.end>=l+i-this.options.scrollPaddingEnd)s="end";else if(n.start<=l+this.options.scrollPaddingStart)s="start";else return[l,s];const a=s==="end"?n.end+this.options.scrollPaddingEnd:n.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(a,s,n.size),s]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(t,{align:s="start",behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(t,s),{adjustments:void 0,behavior:n})},this.scrollToIndex=(t,{align:s="auto",behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),t=Math.max(0,Math.min(t,this.options.count-1));let i=0;const l=10,a=f=>{if(!this.targetWindow)return;const h=this.getOffsetForIndex(t,f);if(!h){console.warn("Failed to get offset for index:",t);return}const[j,p]=h;this._scrollToOffset(j,{adjustments:void 0,behavior:n}),this.targetWindow.requestAnimationFrame(()=>{const M=this.getScrollOffset(),x=this.getOffsetForIndex(t,p);if(!x){console.warn("Failed to get offset for index:",t);return}Ze(x[0],M)||u(p)})},u=f=>{this.targetWindow&&(i++,i<l?this.targetWindow.requestAnimationFrame(()=>a(f)):console.warn(`Failed to scroll to index ${t} after ${l} attempts.`))};a(s)},this.scrollBy=(t,{behavior:s}={})=>{s==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+t,{adjustments:void 0,behavior:s})},this.getTotalSize=()=>{var t;const s=this.getMeasurements();let n;if(s.length===0)n=this.options.paddingStart;else if(this.options.lanes===1)n=((t=s[s.length-1])==null?void 0:t.end)??0;else{const i=Array(this.options.lanes).fill(null);let l=s.length-1;for(;l>=0&&i.some(a=>a===null);){const a=s[l];i[a.lane]===null&&(i[a.lane]=a.end),l--}n=Math.max(...i.filter(a=>a!==null))}return Math.max(n-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(t,{adjustments:s,behavior:n})=>{this.options.scrollToFn(t,{behavior:n,adjustments:s},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(o)}}const Te=(r,o,t,s)=>{for(;r<=o;){const n=(r+o)/2|0,i=t(n);if(i<s)r=n+1;else if(i>s)o=n-1;else return n}return r>0?r-1:0};function ot({measurements:r,outerSize:o,scrollOffset:t,lanes:s}){const n=r.length-1,i=u=>r[u].start;if(r.length<=s)return{startIndex:0,endIndex:n};let l=Te(0,n,i,t),a=l;if(s===1)for(;a<n&&r[a].end<t+o;)a++;else if(s>1){const u=Array(s).fill(0);for(;a<n&&u.some(h=>h<t+o);){const h=r[a];u[h.lane]=h.end,a++}const f=Array(s).fill(t+o);for(;l>=0&&f.some(h=>h>=t);){const h=r[l];f[h.lane]=h.start,l--}l=Math.max(0,l-l%s),a=Math.min(n,a+(s-1-a%s))}return{startIndex:l,endIndex:a}}const Ne=typeof document<"u"?d.useLayoutEffect:d.useEffect;function ct(r){const o=d.useReducer(()=>({}),{})[1],t={...r,onChange:(n,i)=>{var l;i?He.flushSync(o):o(),(l=r.onChange)==null||l.call(r,n,i)}},[s]=d.useState(()=>new at(t));return s.setOptions(t),Ne(()=>s._didMount(),[]),Ne(()=>s._willUpdate()),s}function dt(r){return ct({observeElementRect:nt,observeElementOffset:it,scrollToFn:rt,...r})}function ht({open:r,onOpenChange:o,title:t,description:s,tokenLabel:n="Token",token:i="",inputPlaceholder:l="Type the token exactly as shown",confirmLabel:a="Confirm",cancelLabel:u="Cancel",isValid:f,onConfirm:h}){const j=d.useRef(null),p=d.useRef(null),[M,x]=d.useState(""),T=d.useMemo(()=>{const S=g=>(g||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().toLowerCase();return g=>S(g)===S(i)},[i]),w=(f??T)(M);return d.useEffect(()=>{if(!r)return;p.current=document.activeElement;const S=j.current?.querySelector("input");x(""),S?.focus();const g=L=>{L.key==="Escape"&&o(!1)};return window.addEventListener("keydown",g),()=>{window.removeEventListener("keydown",g),p.current?.focus?.()}},[r,o]),r?e.jsxs("div",{className:"fixed inset-0 z-50",onClick:()=>o(!1),role:"presentation",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",onClick:S=>S.stopPropagation(),children:e.jsx("div",{ref:j,className:"bg-white rounded-xl shadow-xl w-full max-w-md",role:"dialog","aria-modal":"true","aria-labelledby":"confirm-dialog-title",children:e.jsxs("div",{className:"p-4",children:[e.jsx("h3",{id:"confirm-dialog-title",className:"text-lg font-medium mb-2",children:t}),s&&e.jsx("div",{className:"text-sm text-slate-600 mb-3",children:s}),(i||n)&&e.jsx("div",{className:"text-sm mb-3",children:e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-lg border px-2.5 py-1 bg-slate-50",children:[e.jsx("span",{className:"text-xs uppercase text-slate-500",children:n}),e.jsx("span",{className:"font-medium",children:i})]})}),e.jsx($,{placeholder:l,value:M,onChange:S=>x(S.target.value),className:"h-10"}),e.jsxs("div",{className:"flex gap-2 justify-end mt-4",children:[e.jsx(C,{variant:"outline",onClick:()=>o(!1),children:u}),e.jsx(C,{variant:"destructive",disabled:!w,onClick:()=>{h(),o(!1)},children:a})]})]})})})]}):null}function ut(r){switch(r){case y.RECEIVE:return"default";case y.PRODUCE:return"default";case y.ISSUE:return"secondary";case y.WASTE:return"secondary";default:return"secondary"}}function mt({className:r}){return e.jsx("svg",{className:r,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})}function ft({movementId:r,movementType:o,onDelete:t}){return e.jsx(C,{variant:"outline",size:"sm",onClick:t,className:"h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50","aria-label":"Delete movement",title:"Delete movement",children:e.jsx(mt,{className:"h-4 w-4"})})}const Me=1440*60*1e3;function xt(r,o,t){const s=new Date,n=new Date(s.getFullYear(),s.getMonth(),s.getDate()).getTime();if(r==="today")return[n,s.getTime()];if(r==="last7")return[s.getTime()-7*Me,s.getTime()];if(r==="month")return[new Date(s.getFullYear(),s.getMonth(),1).getTime(),s.getTime()];if(r==="custom"){const l=o?new Date(o+"T00:00:00").getTime():s.getTime()-7*Me,a=t?new Date(t+"T23:59:59").getTime():s.getTime();return[Math.min(l,a),Math.max(l,a)]}const i=Math.floor(s.getMonth()/3)*3;return[new Date(s.getFullYear(),i,1).getTime(),s.getTime()]}function bt({movements:r=[],onDeleteMovement:o,onExportExcel:t,onExportJournal:s,getExportedMovements:n,clearExportHistory:i,syncToCloud:l,onRefreshMovements:a}){const[u,f]=d.useState(""),[h,j]=d.useState(""),[p,M]=d.useState(""),[x,T]=d.useState("last7"),[w,S]=d.useState(""),[g,L]=d.useState(""),[U,re]=d.useState(null),[ke,ae]=d.useState(null),[Ie,H]=d.useState(!1),[Oe,K]=d.useState(!1),[Q,ze]=d.useState(!1),[oe,ce]=d.useState(!1),[de,he]=d.useState(!1),[De,R]=d.useState(1),[J,Fe]=d.useState(10),A=d.useDeferredValue(u),P=d.useDeferredValue(h),{onWorkOrderCompleted:ue,onMovementsRefreshRequested:me}=Xe(),Re=d.useMemo(()=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",currencyDisplay:"symbol"}),[]),Ae=d.useMemo(()=>new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"short"}),[]),fe=d.useMemo(()=>["turtle","lion","giraffe","parrot","alligator","jaguar","elephant","wolf","dolphin","eagle"],[]),Pe=c=>{const m=fe[Math.floor(Math.random()*fe.length)]||"turtle";ae(m),re(c)},We=c=>r?.find(m=>m.movementId===c),O=d.useMemo(()=>({sku:A,workOrder:P,type:p,period:x,customStart:x==="custom"?w:"",customEnd:x==="custom"?g:""}),[A,P,p,x,w,g]),xe=()=>{switch(x){case"today":return"Today";case"last7":return"Last 7 days";case"month":return"Current month";case"quarter":return"Current quarter";case"custom":return w&&g?`${w} to ${g}`:"Custom range (incomplete)";default:return x}},_e=()=>{H(!0)},Ve=()=>{t&&t(E,O),H(!1)},Le=()=>{K(!0)},Ue=()=>{s&&s(E,O),K(!1)},Be=async()=>{if(l){ce(!0);try{await l()}finally{ce(!1)}}},qe=async()=>{if(i){he(!0);try{await i()}catch(c){console.error("Failed to clear history:",c)}finally{he(!1)}}},[ge,pe]=d.useMemo(()=>xt(x,w,g),[x,w,g]),E=d.useMemo(()=>{const c=[];return(r||[]).forEach((m,b)=>{if(A&&!m.skuOrName.toLowerCase().includes(A.toLowerCase())||P&&!m.ref.toLowerCase().includes(P.toLowerCase())||p&&m.type!==p)return;const k=m.datetime instanceof Date?m.datetime.getTime():new Date(m.datetime).getTime();k<ge||k>pe||c.push([m,b])}),c.sort(([m],[b])=>{const k=m.datetime instanceof Date?m.datetime.getTime():new Date(m.datetime).getTime();return(b.datetime instanceof Date?b.datetime.getTime():new Date(b.datetime).getTime())-k}),c},[r,A,P,p,ge,pe]),B=d.useMemo(()=>{const c=E.filter(([b])=>[y.RECEIVE,y.PRODUCE,y.WASTE].includes(b.type));if(Q||!n)return c;const m=n();return c.filter(([b])=>!m.has(b.movementId))},[E,Q,n]),z=d.useMemo(()=>{const c=E.filter(([D])=>[y.RECEIVE,y.PRODUCE,y.WASTE].includes(D.type));if(!n)return{newMovements:c.length,alreadyExported:0};const m=n(),b=c.filter(([D])=>!m.has(D.movementId)).length,k=c.length-b;return{newMovements:b,alreadyExported:k}},[E,n]);d.useEffect(()=>{R(1)},[A,P,p,x,w,g]),d.useEffect(()=>{console.log("🔄 Setting up Supabase real-time subscription for movements");const c=Ke.channel("movements_realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"movements"},m=>{console.log("📝 New movement detected via Supabase:",m),a&&(console.log("🔄 Triggering movements refresh from Supabase subscription"),a())}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"movements"},m=>{console.log("📝 Movement updated via Supabase:",m),a&&(console.log("🔄 Triggering movements refresh from Supabase update"),a())}).subscribe(m=>{console.log("📡 Movements subscription status:",m)});return()=>{console.log("🔌 Unsubscribing from movements real-time"),c.unsubscribe()}},[a]),d.useEffect(()=>{const c=ue(b=>{console.log("🎉 Work Order completed event received:",b.detail),a&&(console.log("🔄 Triggering movements refresh from work order completion"),a())}),m=me(b=>{console.log("🔄 Movements refresh requested by:",b.detail.source),a&&(console.log("🔄 Triggering movements refresh from explicit request"),a())});return()=>{c(),m()}},[ue,me,a]);const Y=E.length,W=Math.max(1,Math.ceil(Y/J)),_=Math.min(De,W),G=(_-1)*J,ve=G+J,be=E.slice(G,ve),je=d.useRef(null),ye=dt({count:be.length,getScrollElement:()=>je.current,estimateSize:()=>44,overscan:8});return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(X,{className:"rounded-xl border border-dashed",children:[e.jsx(Z,{className:"py-4",children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4",children:[e.jsxs(ee,{className:"text-lg",children:["Last Movements ",e.jsx("span",{className:"text-sm font-normal text-green-600",children:"🚀 Real-time"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row items-start md:items-center gap-2",children:[e.jsxs(te,{value:x,onValueChange:c=>T(c),children:[e.jsx(se,{className:"h-8 w-[160px] rounded-xl",children:e.jsx(ne,{placeholder:"Period"})}),e.jsxs(ie,{children:[e.jsx(N,{value:"today",children:"Today"}),e.jsx(N,{value:"last7",children:"Last 7 days"}),e.jsx(N,{value:"month",children:"Current month"}),e.jsx(N,{value:"quarter",children:"Current quarter"}),e.jsx(N,{value:"custom",children:"Custom range"})]})]}),x==="custom"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{type:"date",value:w,onChange:c=>S(c.target.value),className:"h-8 rounded-xl w-36"}),e.jsx("span",{className:"text-slate-500",children:"to"}),e.jsx($,{type:"date",value:g,onChange:c=>L(c.target.value),className:"h-8 rounded-xl w-36"})]})]})]})}),e.jsxs(le,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-slate-600",children:["Showing ",E.length," of ",r.length," movements"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(C,{size:"sm",variant:"outline",onClick:_e,disabled:E.length===0,className:"rounded-xl",children:["Export to Excel (",E.length,")"]}),e.jsxs(C,{size:"sm",variant:"outline",onClick:Le,disabled:B.length===0,className:"rounded-xl bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100",children:["Export Journal (",z.newMovements>0&&z.alreadyExported>0?`${z.newMovements} new`:B.length,")"]}),z.alreadyExported>0&&i&&e.jsx(C,{size:"sm",variant:"outline",onClick:qe,disabled:de,className:"rounded-xl text-gray-600 border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",title:"Clear journal export history (creates Excel backup first)",children:de?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin inline-block w-3 h-3 border border-gray-500 border-t-transparent rounded-full mr-1"}),"Clearing..."]}):e.jsx(e.Fragment,{children:"Clear History"})}),l&&e.jsx(C,{size:"sm",variant:"outline",onClick:Be,disabled:oe,className:"rounded-xl text-green-600 border-green-300 hover:bg-green-50 disabled:opacity-50 disabled:cursor-not-allowed",title:"Sync journal history with cloud",children:oe?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin inline-block w-3 h-3 border border-green-500 border-t-transparent rounded-full mr-1"}),"Syncing..."]}):e.jsx(e.Fragment,{children:"☁️ Sync"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsx($,{placeholder:"Filter by SKU or Name",value:u,onChange:c=>f(c.target.value),className:"h-8 rounded-xl"}),e.jsx($,{placeholder:"Filter by WO",value:h,onChange:c=>j(c.target.value),className:"h-8 rounded-xl"}),e.jsxs(te,{value:p,onValueChange:M,children:[e.jsx(se,{className:"h-8 w-full rounded-xl",children:e.jsx(ne,{placeholder:"Movement type"})}),e.jsxs(ie,{children:[e.jsx(N,{value:"",children:"All types"}),e.jsx(N,{value:y.RECEIVE,children:"RECEIVE"}),e.jsx(N,{value:y.ISSUE,children:"ISSUE"}),e.jsx(N,{value:y.WASTE,children:"WASTE"}),e.jsx(N,{value:y.PRODUCE,children:"PRODUCE"})]})]})]}),e.jsx("div",{ref:je,className:"max-h-96 overflow-auto rounded-md border",children:e.jsxs(Je,{className:"w-full",children:[e.jsx("caption",{className:"sr-only",children:"Last Movements – filtered and paginated list"}),e.jsx(Ye,{children:e.jsxs(q,{children:[e.jsx(F,{scope:"col",children:"Date/Time"}),e.jsx(F,{scope:"col",children:"Type"}),e.jsx(F,{scope:"col",children:"SKU / Output name"}),e.jsx(F,{scope:"col",children:"Qty"}),e.jsx(F,{scope:"col",children:"Value"}),e.jsx(F,{scope:"col",children:"Ref"}),e.jsx(F,{scope:"col",children:"Actions"})]})}),e.jsx(Qe,{children:E.length===0?e.jsx(q,{children:e.jsx(I,{colSpan:7,className:"text-sm text-slate-500",children:u||h||p||x!=="last7"||w||g?"No movements match the current filters.":"No movements yet."})}):(()=>{const c=ye.getVirtualItems(),m=c[0]?.start??0,b=c[c.length-1],k=ye.getTotalSize()-(b?.end??0);return e.jsxs(e.Fragment,{children:[m>0&&e.jsx(q,{"aria-hidden":!0,style:{height:m},children:e.jsx(I,{colSpan:7})}),c.map(D=>{const[v,gt]=be[D.index],$e=`${v.ref}|${v.datetime}|${v.type}|${v.skuOrName}`;return e.jsxs(q,{"data-index":D.index,children:[e.jsx("th",{scope:"row",className:"px-4 py-2 text-left font-normal",children:Ae.format(v.datetime instanceof Date?v.datetime:new Date(v.datetime))}),e.jsx(I,{children:e.jsx(Ge,{variant:ut(v.type),children:v.type})}),e.jsx(I,{children:v.skuOrName}),e.jsx(I,{className:v.qty>0?"text-green-600":"text-red-600",children:v.qty>0?`+${v.qty}`:v.qty}),e.jsx(I,{className:v.value>0?"text-green-600":"text-red-600",children:Re.format(v.value)}),e.jsx(I,{children:v.ref}),e.jsx(I,{children:v.type===y.PRODUCE&&o&&e.jsx(ft,{movementId:v.movementId,movementType:v.type,onDelete:()=>Pe(v.movementId)})})]},$e)}),k>0&&e.jsx(q,{"aria-hidden":!0,style:{height:k},children:e.jsx(I,{colSpan:7})})]})})()})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3 pt-2",children:[e.jsxs("div",{className:"text-sm text-slate-600",children:["Showing ",Y===0?0:G+1,"-",Math.min(ve,Y)," of ",Y]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(te,{value:String(J),onValueChange:c=>{Fe(Number(c)),R(1)},children:[e.jsx(se,{className:"h-9 w-[110px]",children:e.jsx(ne,{placeholder:"Page size"})}),e.jsxs(ie,{children:[e.jsx(N,{value:"10",children:"10 / page"}),e.jsx(N,{value:"25",children:"25 / page"}),e.jsx(N,{value:"50",children:"50 / page"}),e.jsx(N,{value:"100",children:"100 / page"})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(C,{variant:"outline",size:"sm",onClick:()=>R(1),disabled:_===1,children:"«"}),e.jsx(C,{variant:"outline",size:"sm",onClick:()=>R(c=>Math.max(1,c-1)),disabled:_===1,children:"Prev"}),e.jsxs("span",{className:"text-sm px-2",children:["Page ",_," / ",W]}),e.jsx(C,{variant:"outline",size:"sm",onClick:()=>R(c=>Math.min(W,c+1)),disabled:_===W,children:"Next"}),e.jsx(C,{variant:"outline",size:"sm",onClick:()=>R(W),disabled:_===W,children:"»"})]})]})]})]})]}),Ie&&e.jsxs("div",{className:"fixed inset-0 z-50",role:"dialog","aria-modal":"true",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:()=>H(!1)}),e.jsx("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[min(100%,500px)]",children:e.jsxs(X,{className:"rounded-2xl shadow-2xl bg-white",children:[e.jsx(Z,{className:"py-4",children:e.jsx(ee,{className:"text-lg",children:"Export Movements to Excel"})}),e.jsxs(le,{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-slate-600",children:["You're about to export ",e.jsxs("strong",{children:[E.length," movement records"]})," to Excel with the following filters applied:"]}),e.jsxs("div",{className:"bg-slate-50 p-3 rounded-lg space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-slate-700",children:"Active Filters:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Period:"})," ",xe()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"SKU/Name:"})," ",O.sku||"All"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Work Order:"})," ",O.workOrder||"All"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Movement Type:"})," ",O.type||"All"]})]})]}),e.jsx("p",{className:"text-xs text-slate-500",children:"The exported file will contain: Date, Time, Type, SKU/Product, Quantity, Value, and Reference columns."})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 p-4 border-t",children:[e.jsx(C,{variant:"outline",onClick:()=>H(!1),children:"Cancel"}),e.jsxs(C,{onClick:Ve,children:["Export ",E.length," Records"]})]})]})})]}),Oe&&e.jsxs("div",{className:"fixed inset-0 z-50",role:"dialog","aria-modal":"true",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:()=>K(!1)}),e.jsx("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[min(100%,600px)]",children:e.jsxs(X,{className:"rounded-2xl shadow-2xl bg-white",children:[e.jsx(Z,{className:"py-4",children:e.jsxs(ee,{className:"text-lg flex items-center gap-2",children:[e.jsx("span",{className:"text-blue-600",children:"📊"}),"Export Journal to Excel"]})}),e.jsxs(le,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm text-slate-600",children:["You're about to export ",e.jsxs("strong",{children:[B.length," movements"]})," as journal entries to Excel. This will create ",e.jsxs("strong",{children:[B.length*2," journal lines"]})," (2 per movement)."]}),e.jsxs("div",{className:"bg-slate-50 p-3 rounded-lg space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-slate-700",children:"Export Status:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"text-green-600",children:[e.jsx("span",{className:"font-medium",children:"New entries:"})," ",z.newMovements]}),e.jsxs("div",{className:"text-amber-600",children:[e.jsx("span",{className:"font-medium",children:"Already exported:"})," ",z.alreadyExported]})]}),z.alreadyExported>0&&e.jsx("div",{className:"mt-3 pt-2 border-t border-slate-200",children:e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Q,onChange:c=>ze(c.target.checked),className:"rounded border-gray-300"}),e.jsx("span",{className:"text-xs text-slate-600",children:"Include already exported entries"})]})})]})]}),e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-blue-700",children:"Active Filters:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Period:"})," ",xe()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"SKU/Name:"})," ",O.sku||"All"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Work Order:"})," ",O.workOrder||"All"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Movement Type:"})," ",O.type||"All"]})]})]}),e.jsxs("div",{className:"bg-green-50 p-3 rounded-lg space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-green-700",children:"Journal Structure:"}),e.jsxs("div",{className:"text-xs text-green-600 space-y-1",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"RECEIVE:"})," Debit Inventory, Credit Accounts Payable"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"PRODUCE:"})," Debit COGS, Credit Inventory"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"WASTE:"})," Debit Shrinkage Expense, Credit Inventory"]})]})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 pt-2",children:[e.jsx(C,{variant:"outline",onClick:()=>K(!1),children:"Cancel"}),e.jsxs(C,{onClick:Ue,className:"bg-blue-600 hover:bg-blue-700 text-white",children:["Export Journal (",B.length*2," lines)"]})]})]})]})})]}),e.jsx(ht,{open:U!==null,onOpenChange:c=>{c||(re(null),ae(null))},title:"Delete Movement",description:e.jsx(e.Fragment,{children:U!==null&&e.jsx("span",{className:"text-sm text-slate-600",children:We(U)?.type===y.PRODUCE?"This will permanently delete the PRODUCE movement and all related WASTE and ISSUE movements, restoring stock with FIFO integrity.":"This will permanently delete the RECEIVE movement and restore stock with FIFO integrity."})}),tokenLabel:"Animal",token:ke||"",inputPlaceholder:"Type the animal exactly as shown",confirmLabel:"Delete",cancelLabel:"Cancel",onConfirm:()=>{U!==null&&o?.(U)}})]})}export{bt as default};
