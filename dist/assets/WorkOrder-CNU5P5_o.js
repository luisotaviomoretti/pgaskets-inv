import{r as o,q as J,j as e,B as re,L as $,T as E,f as L,g as p,h as f,i as T,k as l,I as M,e as N,R as ve,s as Ne,C as be,b as Ie,c as Ce,d as qe,S as Se,l as $e,m as Me,n as We,o as Oe}from"./index-BKRk5lZ_.js";import{L as le,w as Re}from"./schemas-BMOVbwG-.js";import{u as Fe}from"./workOrderEvents-Be-RnPcv.js";function z({message:x,id:y}){return e.jsxs("div",{id:y,className:"flex items-center gap-1 text-sm text-red-600 mt-1",children:[e.jsx(oe,{className:"h-4 w-4"}),e.jsx("span",{children:x})]})}function Qe({skus:x,filter:y,value:k,onChange:Z,placeholder:_,id:W,error:O}){const V=y?x.filter(S=>S.type===y):x;return e.jsxs(Se,{value:k,onValueChange:Z,children:[e.jsx($e,{id:W,className:`h-10 w-full ${O?"border-red-500 focus:ring-red-500":""}`,"aria-invalid":!!O,"aria-describedby":O?`${W}-error`:void 0,children:e.jsx(Me,{placeholder:_})}),e.jsx(We,{children:V.map(S=>e.jsxs(Oe,{value:S.id,children:[S.id," ‚Äî ",S.description]},S.id))})]})}function de({className:x}){return e.jsx("svg",{className:x,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"})})}function Ee({className:x}){return e.jsx("svg",{className:x,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"})})}function oe({className:x}){return e.jsx("svg",{className:x,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z"})})}function X({title:x,icon:y,children:k}){return e.jsxs(be,{className:"rounded-xl border border-dashed",children:[e.jsx(Ie,{className:"py-4",children:e.jsxs(Ce,{className:"flex items-center gap-2 text-lg",children:[y,x]})}),e.jsx(qe,{children:k})]})}function Ke({skus:x,layersBySku:y,onUpdateLayers:k,onUpdateSKU:Z,onAddMovement:_,woId:W,onRefreshInventory:O}){const{emitWorkOrderCompleted:V,emitMovementsRefreshRequested:S}=Fe(),R=o.useCallback(t=>{const s=y[t];return s&&s.length>0?s.reduce((i,r)=>i+(r.remaining||0),0):x.find(i=>i.id===t)?.onHand||0},[y,x]),[d,P]=o.useState([{id:"1",skuId:"",qty:0,notes:""}]),[b,H]=o.useState([]),[g,ee]=o.useState(""),[I,te]=o.useState(0),[U,se]=o.useState(""),[K,ae]=o.useState(""),[w,A]=o.useState(null),[m,ce]=o.useState({}),[B,F]=o.useState(!1),G=o.useRef(""),ue=()=>{const t=new Date,s=n=>n.toString().padStart(2,"0"),a=t.getFullYear(),i=s(t.getMonth()+1),r=s(t.getDate()),c=s(t.getHours()),j=s(t.getMinutes());return`${a}${i}${r}${c}${j}`};if(!G.current){const t=Math.random().toString(36).slice(2,6).toUpperCase();G.current=`WO-${ue()}-${t}`}o.useEffect(()=>{const t=d.filter(i=>i.skuId&&!y[i.skuId]).map(i=>i.skuId);if(t.length===0)return;const a=setTimeout(async()=>{const i=t.map(async r=>{try{console.log(`üîÑ Preloading layers for SKU: ${r}`);const j=(await J(r)||[]).map(n=>{const q=n.date instanceof Date?n.date:new Date(n.date),u=isNaN(q.getTime())?String(n.date):q.toISOString().split("T")[0];return{id:n.id,date:u,remaining:n.remaining,cost:n.cost}});k&&k(r,j),console.log(`‚úÖ Preloaded ${j.length} layers for SKU: ${r}`)}catch(c){console.error(`‚ùå Failed to preload layers for SKU: ${r}`,c)}});await Promise.all(i)},500);return()=>clearTimeout(a)},[d.map(t=>t.skuId).join(","),y,k]),o.useCallback(()=>{const t=[];m.outputName&&t.push("outputName"),m.producedQty&&t.push("producedQty"),d.forEach(s=>{m[`raw-sku-${s.id}`]&&t.push(`raw-sku-${s.id}`),m[`raw-qty-${s.id}`]&&t.push(`raw-qty-${s.id}`)});for(const s of t){const a=document.getElementById(s);if(a){a.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>a.focus&&a.focus(),150);break}}},[m,d]);const me=o.useCallback(()=>{const t=(Math.max(...d.map(s=>parseInt(s.id)),0)+1).toString();P(s=>[...s,{id:t,skuId:"",qty:0,notes:""}])},[d]),xe=o.useCallback(t=>{d.length>1&&P(s=>s.filter(a=>a.id!==t))},[d.length]),Y=o.useCallback((t,s)=>{P(a=>a.map(i=>i.id===t?{...i,...s}:i))},[]),ie=o.useCallback(()=>{const t=new Map;d.filter(s=>s.skuId&&s.qty>0).forEach(s=>{const a=t.get(s.skuId)||0;t.set(s.skuId,a+s.qty)}),H(s=>{const a=[];for(const[i,r]of t.entries()){const c=s.find(j=>j.skuId===i);a.push({skuId:i,wasteQty:c?Math.min(c.wasteQty,r):0,maxWaste:r})}return a})},[d]);o.useEffect(()=>{ie()},[ie]);const he=o.useCallback((t,s)=>{H(a=>a.map(i=>i.skuId===t?{...i,wasteQty:Math.max(0,Math.min(s,i.maxWaste))}:i))},[]),fe=o.useMemo(()=>d.reduce((t,s)=>t+(s.qty||0),0),[d]),je=o.useMemo(()=>b.reduce((t,s)=>t+(s.wasteQty||0),0),[b]),v=o.useMemo(()=>{const t=d.filter(s=>s.skuId&&s.qty>0).map(s=>x.find(a=>a.id===s.skuId)?.unit).filter(Boolean);return t.length>1&&!t.every(s=>s===t[0])},[d,x]);o.useEffect(()=>{if(!w)return;const t=s=>{s.key==="Escape"&&A(null)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[w]),o.useEffect(()=>{w&&(async()=>{try{const s=(await J(w)).map(a=>{const i=a.date instanceof Date?a.date:new Date(a.date),r=isNaN(i.getTime())?String(a.date):i.toISOString().split("T")[0];return{id:a.id,date:r,remaining:a.remaining,cost:a.cost}});k&&k(w,s)}catch(t){console.error("Failed to load layers for modal",w,t)}})()},[w,k]),o.useEffect(()=>{if(!B)return;const t=s=>{s.key==="Escape"&&F(!1)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[B]),o.useEffect(()=>{const t={};d.forEach(a=>{const i=`raw-sku-${a.id}`,r=`raw-qty-${a.id}`;if((a.qty||0)>0&&!a.skuId&&(t[i]="SKU is required for this line"),a.skuId&&(a.qty||0)<=0&&(t[r]="Quantity must be greater than 0"),a.skuId&&(a.qty||0)>0){const c=R(a.skuId);(a.qty||0)>c&&(t[r]="Insufficient stock for this SKU. Receive more in Receiving.")}});const s=new Map;d.filter(a=>a.skuId&&(a.qty||0)>0).forEach(a=>s.set(a.skuId,(s.get(a.skuId)||0)+(a.qty||0)));for(const[a,i]of s.entries()){const r=R(a);i>r+1e-9&&d.forEach(c=>{c.skuId===a&&(t[`raw-qty-${c.id}`]="Insufficient stock across lines for this SKU.")})}g.trim()||(t.outputName="Finished product name is required"),!v&&I<=0&&(t.producedQty="Produced quantity must be greater than 0"),ce(t)},[d,g,I,y,v,R]);const C=o.useMemo(()=>d.filter(t=>t.skuId&&t.qty>0).map(t=>{const s=y[t.skuId]||[],a=[];let i=t.qty;for(const u of s.slice().sort((h,D)=>new Date(h.date).getTime()-new Date(D.date).getTime())){if(i<=0)break;const h=Math.min(i,u.remaining);a.push({layerId:u.id,qty:h,cost:u.cost}),i-=h}const r=a.reduce((u,h)=>u+Math.round(h.cost*100)*h.qty,0),c=r/100,j=a.reduce((u,h)=>u+h.qty,0),n=R(t.skuId),q=j>=t.qty||n>=t.qty;return{skuId:t.skuId,plan:a,totalCost:c,totalCostCents:r,totalQty:j,canFulfill:q}}),[d,y]),pe=C.reduce((t,s)=>t+s.totalCostCents,0)/100,Q=o.useMemo(()=>{const t=new Map;return b.forEach(s=>t.set(s.skuId,(t.get(s.skuId)||0)+(s.wasteQty||0))),C.map(s=>{const a=s.totalQty,i=a>0?s.totalCostCents/a/100:0,r=Math.min(t.get(s.skuId)||0,a),c=Math.max(0,a-r);return{skuId:s.skuId,qty:c,unitCost:i,value:s.totalCostCents/100}})},[C,b]),ye=o.useMemo(()=>Q.reduce((t,s)=>t+s.qty,0),[Q]),ge=o.useMemo(()=>Q.reduce((t,s)=>t+s.value,0),[Q]),ne=o.useMemo(()=>{if(!g.trim()||!v&&I<=0||d.filter(s=>s.skuId&&s.qty>0).length===0)return!1;for(const s of C)if(!s.canFulfill)return!1;return!0},[g,I,d,fe,je,C,v]),ke=async()=>{if(!g.trim()){alert("Finished product name is required to finalize Work Order");return}if(!v&&I<=0){alert("Produced quantity must be greater than 0");return}const t=d.filter(i=>i.skuId&&i.qty>0);if(t.length===0){alert("Add at least one RAW material line with quantity > 0");return}const s=I;for(const i of C)if(!i.canFulfill){const r=t.filter(j=>j.skuId===i.skuId).reduce((j,n)=>j+n.qty,0),c=R(i.skuId);alert(`Insufficient inventory for SKU ${i.skuId}. Required: ${r}, Available: ${c}`);return}const a=W&&W.trim()?W.trim():G.current;try{const r=d.filter(u=>u.skuId&&u.qty>0).map(u=>({sku:u.skuId,unit:x.find(h=>h.id===u.skuId)?.unit||"",qty:u.qty})),c=b.map(u=>({sku:u.skuId,unit:x.find(h=>h.id===u.skuId)?.unit||"",qty:u.wasteQty})),n=r.map(u=>u.unit).filter(u=>!!u)[0]||"",q={code:a,datetime:new Date().toISOString(),outputName:g.trim(),outputUnit:n,mode:"MANUAL",outputQty:s,raw:r,waste:c};Re.parse(q)}catch(i){const r=i?.errors?.[0]?.message||"Invalid Work Order data. Please review the form.";alert(r);return}try{const i=await Ne({outputName:g.trim(),outputQuantity:s,rawMaterials:d.filter(n=>n.skuId&&n.qty>0).map(n=>({skuId:n.skuId,quantity:n.qty})),wasteLines:b.filter(n=>n.wasteQty>0).map(n=>({skuId:n.skuId,quantity:n.wasteQty})),date:new Date,reference:a,notes:JSON.stringify({client:U,invoice:K})});console.log("üè≠ Work Order Result Details:",{workOrderId:i.workOrderId,outputQuantity:s,outputName:g.trim(),financials:{totalRawCost:i.totalRawCost,totalWasteCost:i.totalWasteCost,netProduceCost:i.netProduceCost||i.totalRawCost-i.totalWasteCost,outputUnitCost:i.outputUnitCost},hasMixedUnits:v,rawMaterials:d.filter(n=>n.skuId&&n.qty>0),wasteLines:b.filter(n=>n.wasteQty>0),result:i});const r=i.netProduceCost||i.totalRawCost-i.totalWasteCost,c=`
üìä Cost Breakdown:
‚Ä¢ RAW Materials: $${i.totalRawCost?.toFixed(2)||"0.00"}
‚Ä¢ WASTE: $${i.totalWasteCost?.toFixed(2)||"0.00"}
‚Ä¢ NET PRODUCE: $${r?.toFixed(2)||"0.00"}
‚Ä¢ Unit Cost: $${i.outputUnitCost?.toFixed(2)||"0.00"}/${s} units`;alert(`‚úÖ Work Order ${i.workOrderId} finalized successfully!
${s} units of "${g.trim()}" produced.

${c}`),V({workOrderId:i.workOrderId,outputName:g.trim(),outputQuantity:s,totalRawCost:i.totalRawCost||0}),S("WorkOrder.finalizeWO");const j=Array.from(new Set(d.filter(n=>n.skuId&&n.qty>0).map(n=>n.skuId)));for(const n of j)try{const u=(await J(n)).map(h=>{const D=h.date instanceof Date?h.date:new Date(h.date),we=isNaN(D.getTime())?String(h.date):D.toISOString().split("T")[0];return{id:h.id,date:we,remaining:h.remaining,cost:h.cost}});k&&k(n,u)}catch(q){console.error("Failed to refresh layers for",n,q)}O&&O(),P([{id:"1",skuId:"",qty:0,notes:""}]),H([]),ee(""),te(0),se(""),ae("")}catch(i){const r=i?.message||"Failed to finalize Work Order. Please try again.";alert(r)}};return e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs(X,{title:"Work Order ‚Äî Finalization",icon:e.jsx(de,{className:"h-5 w-5 text-slate-500"}),children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(re,{children:"WO-00425"}),e.jsx(re,{variant:"secondary",children:"OPEN"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx($,{className:"text-xs text-slate-500 mb-1.5",children:"1) Raw material consumption (FIFO from oldest layers)"}),e.jsxs("div",{className:"rounded-2xl border border-dashed p-3",children:[e.jsxs(E,{children:[e.jsx(L,{children:e.jsxs(p,{children:[e.jsx(f,{children:"SKU (Raw)"}),e.jsx(f,{children:"Quantity"}),e.jsx(f,{children:"Notes"}),e.jsx(f,{})]})}),e.jsx(T,{children:d.map(t=>e.jsxs(p,{children:[e.jsxs(l,{className:"min-w-[220px]",children:[e.jsx(Qe,{skus:x,filter:"RAW",value:t.skuId,onChange:s=>Y(t.id,{skuId:s}),placeholder:"Select Raw SKU",id:`raw-sku-${t.id}`,error:m[`raw-sku-${t.id}`]}),m[`raw-sku-${t.id}`]&&e.jsx(z,{id:`raw-sku-${t.id}-error`,message:m[`raw-sku-${t.id}`]})]}),e.jsxs(l,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{id:`raw-qty-${t.id}`,type:"number",min:"0",step:"any",value:t.qty||"",onChange:s=>Y(t.id,{qty:Math.max(0,parseFloat(s.target.value||"0"))}),placeholder:"0","aria-invalid":!!m[`raw-qty-${t.id}`],"aria-describedby":m[`raw-qty-${t.id}`]?`raw-qty-${t.id}-error`:void 0,className:`flex-1 h-10 ${m[`raw-qty-${t.id}`]?"border-red-500 focus:ring-red-500":""}`}),e.jsx("span",{className:"text-xs text-slate-500 min-w-[36px] text-right",children:x.find(s=>s.id===t.skuId)?.unit??""})]}),m[`raw-qty-${t.id}`]&&e.jsx(z,{id:`raw-qty-${t.id}-error`,message:m[`raw-qty-${t.id}`]})]}),e.jsx(l,{children:e.jsx(M,{value:t.notes,onChange:s=>Y(t.id,{notes:s.target.value}),placeholder:"e.g., Coil A",className:"h-10"})}),e.jsx(l,{className:"text-right",children:e.jsxs("div",{className:"flex items-center gap-3 justify-end",children:[e.jsx(N,{variant:"outline",className:"text-green-600 px-0 border-0 hover:bg-transparent",onClick:()=>t.skuId&&A(t.skuId),disabled:!t.skuId,children:e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(le,{className:"h-4 w-4 text-green-600"}),"See Raw Layers (balance)"]})}),e.jsx(N,{variant:"outline",onClick:()=>xe(t.id),disabled:d.length<=1,children:"Remove"})]})})]},t.id))})]}),e.jsxs("div",{className:"flex items-center justify-between pt-2 text-xs text-slate-500",children:[e.jsx("div",{children:"Consumption plan (FIFO) below is auto-calculated."}),e.jsx(N,{size:"sm",variant:"outline",onClick:me,children:"Add line"})]})]})]}),e.jsxs("div",{children:[e.jsx($,{className:"text-xs text-slate-500 mb-1.5",children:"2) Waste"}),e.jsxs("div",{className:"rounded-2xl border border-dashed p-3 space-y-2",children:[b.length===0?e.jsx("p",{className:"text-xs text-slate-500",children:"Waste lines will appear for each RAW SKU with qty > 0."}):e.jsxs(E,{children:[e.jsx(L,{children:e.jsxs(p,{children:[e.jsx(f,{children:"SKU"}),e.jsx(f,{children:"Waste qty"}),e.jsx(f,{children:"Max"})]})}),e.jsx(T,{children:b.map(t=>e.jsxs(p,{children:[e.jsx(l,{children:t.skuId}),e.jsx(l,{className:"min-w-[200px]",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{id:`waste-qty-${t.skuId}`,type:"number",min:"0",step:"any",max:t.maxWaste,value:t.wasteQty||"",onChange:s=>he(t.skuId,Math.max(0,parseFloat(s.target.value||"0"))),placeholder:"0",className:"flex-1 h-10"}),e.jsx("span",{className:"text-xs text-slate-500 min-w-[36px] text-right",children:x.find(s=>s.id===t.skuId)?.unit??""})]})}),e.jsx(l,{className:"text-xs text-slate-500",children:t.maxWaste})]},t.skuId))})]}),e.jsx("p",{className:"text-xs text-slate-500",children:"Waste value is calculated via FIFO from the consumed layers per SKU."})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx($,{className:"text-xs text-slate-500 mb-1.5",children:"3) Output"}),e.jsxs("div",{className:"rounded-2xl border border-dashed p-4 grid grid-cols-1 md:grid-cols-12 gap-4",children:[e.jsxs("div",{className:"md:col-span-12 lg:col-span-6",children:[e.jsx($,{className:"mb-1.5 block",children:"Finished product name *"}),e.jsx(M,{id:"outputName",value:g,onChange:t=>ee(t.target.value),placeholder:"e.g., Gasket Kit 50mm",className:`h-10 w-full ${m.outputName?"border-red-500 focus:ring-red-500":""}`,"aria-invalid":!!m.outputName,"aria-describedby":m.outputName?"outputName-error":void 0}),m.outputName&&e.jsx(z,{id:"outputName-error",message:m.outputName})]}),e.jsxs("div",{className:"md:col-span-6 lg:col-span-3",children:[e.jsxs($,{className:"mb-1.5 block",children:["Produced quantity",v?"":" *"]}),e.jsx(M,{id:"producedQty",type:"number",value:I,onChange:t=>te(Math.max(0,parseFloat(t.target.value||"0"))),placeholder:"0",className:`h-10 w-full ${m.producedQty?"border-red-500 focus:ring-red-500":""}`,"aria-invalid":!!m.producedQty,"aria-describedby":m.producedQty?"producedQty-error":void 0}),!v&&m.producedQty&&e.jsx(z,{id:"producedQty-error",message:m.producedQty}),v&&e.jsx("div",{className:"text-xs text-blue-600 mt-1",children:"Mixed units: any quantity allowed."})]}),e.jsxs("div",{className:"md:col-span-12 lg:col-span-6",children:[e.jsx($,{className:"mb-1.5 block",children:"Client (free text)"}),e.jsx(M,{id:"woClient",value:U,onChange:t=>se(t.target.value),placeholder:"e.g., ACME Corp",className:"h-10 w-full"})]}),e.jsxs("div",{className:"md:col-span-12 lg:col-span-6",children:[e.jsx($,{className:"mb-1.5 block",children:"Invoice number (free text)"}),e.jsx(M,{id:"woInvoice",value:K,onChange:t=>ae(t.target.value),placeholder:"e.g., INV-2025-0001",className:"h-10 w-full"})]})]})]}),e.jsxs("div",{className:"md:col-span-2 flex items-center gap-2",children:[e.jsx(N,{className:"rounded-xl",onClick:()=>F(!0),disabled:!ne,children:"Finalize WO"}),!ne&&e.jsx(N,{type:"button",variant:"outline",className:"rounded-xl",onClick:()=>{const t=[];g.trim()||t.push("‚ùå Finished product name is required"),!v&&I<=0&&t.push("‚ùå Produced quantity must be > 0"),d.filter(a=>a.skuId&&a.qty>0).length===0&&t.push("‚ùå Add at least one RAW material line with quantity > 0");for(const a of C)if(!a.canFulfill){const i=d.filter(c=>c.skuId===a.skuId).reduce((c,j)=>c+j.qty,0),r=R(a.skuId);t.push(`‚ùå Insufficient stock for ${a.skuId}: need ${i}, available ${r}`)}alert(`Cannot finalize Work Order:

`+t.join(`
`))},children:"Debug issues"}),e.jsx(N,{variant:"outline",className:"rounded-xl",children:"Save draft"})]})]})]}),e.jsx(X,{title:"FIFO breakdown (auto)",icon:e.jsx(Ee,{className:"h-5 w-5 text-slate-500"}),children:e.jsxs(E,{children:[e.jsx(L,{children:e.jsxs(p,{children:[e.jsx(f,{children:"SKU"}),e.jsx(f,{children:"Layer"}),e.jsx(f,{children:"Qty"}),e.jsx(f,{children:"Unit cost"}),e.jsx(f,{children:"Value"})]})}),e.jsxs(T,{children:[C.length===0?e.jsx(p,{children:e.jsx(l,{colSpan:5,className:"text-sm text-slate-500",children:"No consumption planned."})}):C.map(t=>e.jsxs(ve.Fragment,{children:[e.jsx(p,{children:e.jsx(l,{colSpan:5,className:"text-sm text-slate-500",children:t.skuId})}),t.plan.map(s=>e.jsxs(p,{children:[e.jsx(l,{}),e.jsx(l,{children:s.layerId}),e.jsx(l,{children:s.qty}),e.jsxs(l,{children:["$ ",s.cost.toFixed(2)]}),e.jsxs(l,{children:["$ ",(s.qty*s.cost).toFixed(2)]})]},s.layerId)),e.jsxs(p,{children:[e.jsx(l,{className:"font-medium",colSpan:2,children:"Total"}),e.jsx(l,{className:"font-medium",children:t.totalQty}),e.jsx(l,{}),e.jsxs(l,{className:"font-medium",children:["$ ",t.totalCost.toFixed(2)]})]})]},t.skuId)),e.jsxs(p,{children:[e.jsx(l,{className:"font-medium",colSpan:4,children:"Grand Total"}),e.jsxs(l,{className:"font-medium",children:["$ ",pe.toFixed(2)]})]})]})]})}),e.jsx(X,{title:"Validation notes",icon:e.jsx(oe,{className:"h-5 w-5 text-amber-500"}),children:e.jsxs("ul",{className:"text-sm list-disc pl-5 space-y-1 text-slate-600",children:[e.jsx("li",{children:"No negative balance in Raw or Sellable."}),e.jsx("li",{children:"Output name is free text and will appear in Movements once you finalize."}),e.jsxs("li",{children:[e.jsx("b",{children:"Sufficient stock:"})," Raw material must have enough inventory to consume."]}),e.jsxs("li",{children:[e.jsx("b",{children:"Produced > 0:"})," Production quantity must be greater than zero."]}),e.jsxs("li",{children:[e.jsx("b",{children:"Output name required:"})," Output name cannot be empty to finalize WO."]}),e.jsxs("li",{children:[e.jsx("b",{children:"Realistic ratios:"})," Raw material consumption can exceed production (normal in manufacturing)."]})]})})]}),w&&e.jsxs("div",{className:"fixed inset-0 z-50",onClick:()=>A(null),children:[e.jsx("div",{className:"absolute inset-0 bg-black/40"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-5 w-5 text-green-600"}),e.jsxs("span",{className:"font-medium",children:["Raw Layers (balance) ‚Äî ",w]})]}),e.jsx(N,{variant:"outline",onClick:()=>A(null),children:"‚úï"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("p",{className:"text-xs text-slate-600",children:"Note: quantities will be consumed from the oldest inventory layers first (FIFO)."}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(E,{children:[e.jsx(L,{children:e.jsxs(p,{children:[e.jsx(f,{children:"Layer"}),e.jsx(f,{children:"Date"}),e.jsx(f,{children:"Remaining"}),e.jsx(f,{children:"Cost"})]})}),e.jsxs(T,{children:[(y[w]||[]).slice().sort((t,s)=>new Date(t.date).getTime()-new Date(s.date).getTime()).map(t=>e.jsxs(p,{children:[e.jsx(l,{children:t.id}),e.jsx(l,{children:t.date}),e.jsx(l,{children:t.remaining}),e.jsxs(l,{children:["$ ",t.cost.toFixed(2)]})]},t.id)),(y[w]||[]).length===0&&e.jsx(p,{children:e.jsx(l,{colSpan:4,className:"text-sm text-slate-500",children:"No layers for this SKU."})})]})]})})]})]})})]}),B&&e.jsxs("div",{className:"fixed inset-0 z-50",onClick:()=>F(!1),children:[e.jsx("div",{className:"absolute inset-0 bg-black/40"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl w-full max-w-3xl",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-5 w-5 text-slate-500"}),e.jsx("span",{className:"font-medium",children:"Confirm Work Order"})]}),e.jsx(N,{variant:"outline",onClick:()=>F(!1),children:"‚úï"})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("p",{className:"text-sm text-slate-600",children:"Please review the consumption summary (FIFO) before finalizing."}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(E,{children:[e.jsx(L,{children:e.jsxs(p,{children:[e.jsx(f,{children:"SKU"}),e.jsx(f,{className:"text-right",children:"Quantity"}),e.jsx(f,{className:"text-right",children:"Unit cost"}),e.jsx(f,{className:"text-right",children:"Value"})]})}),e.jsxs(T,{children:[Q.length===0?e.jsx(p,{children:e.jsx(l,{colSpan:4,className:"text-sm text-slate-500",children:"No items to finalize."})}):Q.map(t=>e.jsxs(p,{children:[e.jsx(l,{children:t.skuId}),e.jsx(l,{className:"text-right",children:t.qty}),e.jsxs(l,{className:"text-right",children:["$ ",t.unitCost.toFixed(2)]}),e.jsxs(l,{className:"text-right",children:["$ ",t.value.toFixed(2)]})]},t.skuId)),e.jsxs(p,{children:[e.jsx(l,{className:"font-medium",children:"Totals"}),e.jsx(l,{className:"font-medium text-right",children:ye}),e.jsx(l,{}),e.jsxs(l,{className:"font-medium text-right",children:["$ ",ge.toFixed(2)]})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-slate-700",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Output name:"})," ",e.jsx("b",{children:g||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Produced qty:"})," ",e.jsx("b",{children:I})]}),U&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Client:"})," ",e.jsx("b",{children:U})]}),K&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500",children:"Invoice:"})," ",e.jsx("b",{children:K})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 pt-2",children:[e.jsx(N,{variant:"outline",onClick:()=>F(!1),children:"Cancel"}),e.jsx(N,{onClick:()=>{F(!1),ke()},children:"Confirm & Finalize"})]})]})]})})]})]})}export{Ke as default};
