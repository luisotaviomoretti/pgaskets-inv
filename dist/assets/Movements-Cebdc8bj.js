import{r as u,a as tt,j as e,I as G,B as M,M as x,y as st,C as ne,f as ie,h as re,S as le,b as ae,c as oe,d as ce,e as C,i as de,T as nt,l as it,n as J,o as P,q as rt,s as R,k as lt}from"./index-Ch5fV0aO.js";import{u as at}from"./workOrderEvents-Be-RnPcv.js";function _(r,d,t){let s=t.initialDeps??[],n;function i(){var l,a,f,v;let m;t.key&&((l=t.debug)!=null&&l.call(t))&&(m=Date.now());const w=r();if(!(w.length!==s.length||w.some((j,D)=>s[D]!==j)))return n;s=w;let k;if(t.key&&((a=t.debug)!=null&&a.call(t))&&(k=Date.now()),n=d(...w),t.key&&((f=t.debug)!=null&&f.call(t))){const j=Math.round((Date.now()-m)*100)/100,D=Math.round((Date.now()-k)*100)/100,N=D/16,S=(b,V)=>{for(b=String(b);b.length<V;)b=" "+b;return b};console.info(`%c‚è± ${S(D,5)} /${S(j,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*N,120))}deg 100% 31%);`,t?.key)}return(v=t?.onChange)==null||v.call(t,n),n}return i.updateDeps=l=>{s=l},i}function Me(r,d){if(r===void 0)throw new Error("Unexpected undefined");return r}const ot=(r,d)=>Math.abs(r-d)<1.01,ct=(r,d,t)=>{let s;return function(...n){r.clearTimeout(s),s=r.setTimeout(()=>d.apply(this,n),t)}},Te=r=>{const{offsetWidth:d,offsetHeight:t}=r;return{width:d,height:t}},dt=r=>r,ut=r=>{const d=Math.max(r.startIndex-r.overscan,0),t=Math.min(r.endIndex+r.overscan,r.count-1),s=[];for(let n=d;n<=t;n++)s.push(n);return s},ht=(r,d)=>{const t=r.scrollElement;if(!t)return;const s=r.targetWindow;if(!s)return;const n=l=>{const{width:a,height:f}=l;d({width:Math.round(a),height:Math.round(f)})};if(n(Te(t)),!s.ResizeObserver)return()=>{};const i=new s.ResizeObserver(l=>{const a=()=>{const f=l[0];if(f?.borderBoxSize){const v=f.borderBoxSize[0];if(v){n({width:v.inlineSize,height:v.blockSize});return}}n(Te(t))};r.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(a):a()});return i.observe(t,{box:"border-box"}),()=>{i.unobserve(t)}},ke={passive:!0},De=typeof window>"u"?!0:"onscrollend"in window,mt=(r,d)=>{const t=r.scrollElement;if(!t)return;const s=r.targetWindow;if(!s)return;let n=0;const i=r.options.useScrollendEvent&&De?()=>{}:ct(s,()=>{d(n,!1)},r.options.isScrollingResetDelay),l=m=>()=>{const{horizontal:w,isRtl:y}=r.options;n=w?t.scrollLeft*(y&&-1||1):t.scrollTop,i(),d(n,m)},a=l(!0),f=l(!1);f(),t.addEventListener("scroll",a,ke);const v=r.options.useScrollendEvent&&De;return v&&t.addEventListener("scrollend",f,ke),()=>{t.removeEventListener("scroll",a),v&&t.removeEventListener("scrollend",f)}},ft=(r,d,t)=>{if(d?.borderBoxSize){const s=d.borderBoxSize[0];if(s)return Math.round(s[t.options.horizontal?"inlineSize":"blockSize"])}return r[t.options.horizontal?"offsetWidth":"offsetHeight"]},xt=(r,{adjustments:d=0,behavior:t},s)=>{var n,i;const l=r+d;(i=(n=s.scrollElement)==null?void 0:n.scrollTo)==null||i.call(n,{[s.options.horizontal?"left":"top"]:l,behavior:t})};class gt{constructor(d){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let t=null;const s=()=>t||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:t=new this.targetWindow.ResizeObserver(n=>{n.forEach(i=>{const l=()=>{this._measureElement(i.target,i)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(l):l()})}));return{disconnect:()=>{var n;(n=s())==null||n.disconnect(),t=null},observe:n=>{var i;return(i=s())==null?void 0:i.observe(n,{box:"border-box"})},unobserve:n=>{var i;return(i=s())==null?void 0:i.unobserve(n)}}})(),this.range=null,this.setOptions=t=>{Object.entries(t).forEach(([s,n])=>{typeof n>"u"&&delete t[s]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:dt,rangeExtractor:ut,onChange:()=>{},measureElement:ft,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...t}},this.notify=t=>{var s,n;(n=(s=this.options).onChange)==null||n.call(s,this,t)},this.maybeNotify=_(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),t=>{this.notify(t)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(t=>t()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var t;const s=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==s){if(this.cleanup(),!s){this.maybeNotify();return}this.scrollElement=s,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((t=this.scrollElement)==null?void 0:t.window)??null,this.elementsCache.forEach(n=>{this.observer.observe(n)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,n=>{this.scrollRect=n,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(n,i)=>{this.scrollAdjustments=0,this.scrollDirection=i?this.getScrollOffset()<n?"forward":"backward":null,this.scrollOffset=n,this.isScrolling=i,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(t,s)=>{const n=new Map,i=new Map;for(let l=s-1;l>=0;l--){const a=t[l];if(n.has(a.lane))continue;const f=i.get(a.lane);if(f==null||a.end>f.end?i.set(a.lane,a):a.end<f.end&&n.set(a.lane,!0),n.size===this.options.lanes)break}return i.size===this.options.lanes?Array.from(i.values()).sort((l,a)=>l.end===a.end?l.index-a.index:l.end-a.end)[0]:void 0},this.getMeasurementOptions=_(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(t,s,n,i,l)=>(this.pendingMeasuredCacheIndexes=[],{count:t,paddingStart:s,scrollMargin:n,getItemKey:i,enabled:l}),{key:!1}),this.getMeasurements=_(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:t,paddingStart:s,scrollMargin:n,getItemKey:i,enabled:l},a)=>{if(!l)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(m=>{this.itemSizeCache.set(m.key,m.size)}));const f=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const v=this.measurementsCache.slice(0,f);for(let m=f;m<t;m++){const w=i(m),y=this.options.lanes===1?v[m-1]:this.getFurthestMeasurement(v,m),k=y?y.end+this.options.gap:s+n,j=a.get(w),D=typeof j=="number"?j:this.options.estimateSize(m),N=k+D,S=y?y.lane:m%this.options.lanes;v[m]={index:m,start:k,size:D,end:N,key:w,lane:S}}return this.measurementsCache=v,v},{key:!1,debug:()=>this.options.debug}),this.calculateRange=_(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(t,s,n,i)=>this.range=t.length>0&&s>0?pt({measurements:t,outerSize:s,scrollOffset:n,lanes:i}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=_(()=>{let t=null,s=null;const n=this.calculateRange();return n&&(t=n.startIndex,s=n.endIndex),this.maybeNotify.updateDeps([this.isScrolling,t,s]),[this.options.rangeExtractor,this.options.overscan,this.options.count,t,s]},(t,s,n,i,l)=>i===null||l===null?[]:t({startIndex:i,endIndex:l,overscan:s,count:n}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=t=>{const s=this.options.indexAttribute,n=t.getAttribute(s);return n?parseInt(n,10):(console.warn(`Missing attribute name '${s}={index}' on measured element.`),-1)},this._measureElement=(t,s)=>{const n=this.indexFromElement(t),i=this.measurementsCache[n];if(!i)return;const l=i.key,a=this.elementsCache.get(l);a!==t&&(a&&this.observer.unobserve(a),this.observer.observe(t),this.elementsCache.set(l,t)),t.isConnected&&this.resizeItem(n,this.options.measureElement(t,s,this))},this.resizeItem=(t,s)=>{const n=this.measurementsCache[t];if(!n)return;const i=this.itemSizeCache.get(n.key)??n.size,l=s-i;l!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(n,l,this):n.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=l,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(n.index),this.itemSizeCache=new Map(this.itemSizeCache.set(n.key,s)),this.notify(!1))},this.measureElement=t=>{if(!t){this.elementsCache.forEach((s,n)=>{s.isConnected||(this.observer.unobserve(s),this.elementsCache.delete(n))});return}this._measureElement(t,void 0)},this.getVirtualItems=_(()=>[this.getVirtualIndexes(),this.getMeasurements()],(t,s)=>{const n=[];for(let i=0,l=t.length;i<l;i++){const a=t[i],f=s[a];n.push(f)}return n},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=t=>{const s=this.getMeasurements();if(s.length!==0)return Me(s[Ae(0,s.length-1,n=>Me(s[n]).start,t)])},this.getOffsetForAlignment=(t,s,n=0)=>{const i=this.getSize(),l=this.getScrollOffset();s==="auto"&&(s=t>=l+i?"end":"start"),s==="center"?t+=(n-i)/2:s==="end"&&(t-=i);const a=this.getTotalSize()+this.options.scrollMargin-i;return Math.max(Math.min(a,t),0)},this.getOffsetForIndex=(t,s="auto")=>{t=Math.max(0,Math.min(t,this.options.count-1));const n=this.measurementsCache[t];if(!n)return;const i=this.getSize(),l=this.getScrollOffset();if(s==="auto")if(n.end>=l+i-this.options.scrollPaddingEnd)s="end";else if(n.start<=l+this.options.scrollPaddingStart)s="start";else return[l,s];const a=s==="end"?n.end+this.options.scrollPaddingEnd:n.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(a,s,n.size),s]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(t,{align:s="start",behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(t,s),{adjustments:void 0,behavior:n})},this.scrollToIndex=(t,{align:s="auto",behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),t=Math.max(0,Math.min(t,this.options.count-1));let i=0;const l=10,a=v=>{if(!this.targetWindow)return;const m=this.getOffsetForIndex(t,v);if(!m){console.warn("Failed to get offset for index:",t);return}const[w,y]=m;this._scrollToOffset(w,{adjustments:void 0,behavior:n}),this.targetWindow.requestAnimationFrame(()=>{const k=this.getScrollOffset(),j=this.getOffsetForIndex(t,y);if(!j){console.warn("Failed to get offset for index:",t);return}ot(j[0],k)||f(y)})},f=v=>{this.targetWindow&&(i++,i<l?this.targetWindow.requestAnimationFrame(()=>a(v)):console.warn(`Failed to scroll to index ${t} after ${l} attempts.`))};a(s)},this.scrollBy=(t,{behavior:s}={})=>{s==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+t,{adjustments:void 0,behavior:s})},this.getTotalSize=()=>{var t;const s=this.getMeasurements();let n;if(s.length===0)n=this.options.paddingStart;else if(this.options.lanes===1)n=((t=s[s.length-1])==null?void 0:t.end)??0;else{const i=Array(this.options.lanes).fill(null);let l=s.length-1;for(;l>=0&&i.some(a=>a===null);){const a=s[l];i[a.lane]===null&&(i[a.lane]=a.end),l--}n=Math.max(...i.filter(a=>a!==null))}return Math.max(n-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(t,{adjustments:s,behavior:n})=>{this.options.scrollToFn(t,{behavior:n,adjustments:s},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(d)}}const Ae=(r,d,t,s)=>{for(;r<=d;){const n=(r+d)/2|0,i=t(n);if(i<s)r=n+1;else if(i>s)d=n-1;else return n}return r>0?r-1:0};function pt({measurements:r,outerSize:d,scrollOffset:t,lanes:s}){const n=r.length-1,i=f=>r[f].start;if(r.length<=s)return{startIndex:0,endIndex:n};let l=Ae(0,n,i,t),a=l;if(s===1)for(;a<n&&r[a].end<t+d;)a++;else if(s>1){const f=Array(s).fill(0);for(;a<n&&f.some(m=>m<t+d);){const m=r[a];f[m.lane]=m.end,a++}const v=Array(s).fill(t+d);for(;l>=0&&v.some(m=>m>=t);){const m=r[l];v[m.lane]=m.start,l--}l=Math.max(0,l-l%s),a=Math.min(n,a+(s-1-a%s))}return{startIndex:l,endIndex:a}}const Ie=typeof document<"u"?u.useLayoutEffect:u.useEffect;function vt(r){const d=u.useReducer(()=>({}),{})[1],t={...r,onChange:(n,i)=>{var l;i?tt.flushSync(d):d(),(l=r.onChange)==null||l.call(r,n,i)}},[s]=u.useState(()=>new gt(t));return s.setOptions(t),Ie(()=>s._didMount(),[]),Ie(()=>s._willUpdate()),s}function yt(r){return vt({observeElementRect:ht,observeElementOffset:mt,scrollToFn:xt,...r})}function jt({open:r,onOpenChange:d,title:t,description:s,tokenLabel:n="Token",token:i="",inputPlaceholder:l="Type the token exactly as shown",confirmLabel:a="Confirm",cancelLabel:f="Cancel",isValid:v,onConfirm:m}){const w=u.useRef(null),y=u.useRef(null),[k,j]=u.useState(""),D=u.useMemo(()=>{const S=b=>(b||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().toLowerCase();return b=>S(b)===S(i)},[i]),N=(v??D)(k);return u.useEffect(()=>{if(!r)return;y.current=document.activeElement;const S=w.current?.querySelector("input");j(""),S?.focus();const b=V=>{V.key==="Escape"&&d(!1)};return window.addEventListener("keydown",b),()=>{window.removeEventListener("keydown",b),y.current?.focus?.()}},[r,d]),r?e.jsxs("div",{className:"fixed inset-0 z-50",onClick:()=>d(!1),role:"presentation",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",onClick:S=>S.stopPropagation(),children:e.jsx("div",{ref:w,className:"bg-white rounded-xl shadow-xl w-full max-w-md",role:"dialog","aria-modal":"true","aria-labelledby":"confirm-dialog-title",children:e.jsxs("div",{className:"p-4",children:[e.jsx("h3",{id:"confirm-dialog-title",className:"text-lg font-medium mb-2",children:t}),s&&e.jsx("div",{className:"text-sm text-slate-600 mb-3",children:s}),(i||n)&&e.jsx("div",{className:"text-sm mb-3",children:e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-lg border px-2.5 py-1 bg-slate-50",children:[e.jsx("span",{className:"text-xs uppercase text-slate-500",children:n}),e.jsx("span",{className:"font-medium",children:i})]})}),e.jsx(G,{placeholder:l,value:k,onChange:S=>j(S.target.value),className:"h-10"}),e.jsxs("div",{className:"flex gap-2 justify-end mt-4",children:[e.jsx(M,{variant:"outline",onClick:()=>d(!1),children:f}),e.jsx(M,{variant:"destructive",disabled:!N,onClick:()=>{m(),d(!1)},children:a})]})]})})})]}):null}function bt(r){switch(r){case x.RECEIVE:return"default";case x.PRODUCE:return"default";case x.ISSUE:return"secondary";case x.WASTE:return"secondary";case x.DAMAGE:return"destructive";case x.ADJUSTMENT:return"destructive";default:return"secondary"}}function wt({className:r}){return e.jsx("svg",{className:r,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})}function Et({movementId:r,movementType:d,onDelete:t}){return e.jsx(M,{variant:"outline",size:"sm",onClick:t,className:"h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50","aria-label":"Delete movement",title:"Delete movement",children:e.jsx(wt,{className:"h-4 w-4"})})}const Oe=1440*60*1e3;function Nt(r,d,t){const s=new Date,n=new Date(s.getFullYear(),s.getMonth(),s.getDate()).getTime();if(r==="today")return[n,s.getTime()];if(r==="last7")return[s.getTime()-7*Oe,s.getTime()];if(r==="month")return[new Date(s.getFullYear(),s.getMonth(),1).getTime(),s.getTime()];if(r==="custom"){const l=d?new Date(d+"T00:00:00").getTime():s.getTime()-7*Oe,a=t?new Date(t+"T23:59:59").getTime():s.getTime();return[Math.min(l,a),Math.max(l,a)]}const i=Math.floor(s.getMonth()/3)*3;return[new Date(s.getFullYear(),i,1).getTime(),s.getTime()]}function Tt({movements:r=[],onDeleteMovement:d,onExportExcel:t,onExportJournal:s,getExportedMovements:n,clearExportHistory:i,syncToCloud:l,onRefreshMovements:a}){const[f,v]=u.useState(""),[m,w]=u.useState(""),[y,k]=u.useState(""),[j,D]=u.useState("last7"),[N,S]=u.useState(""),[b,V]=u.useState(null),[ue,Re]=u.useState({x:0,y:0}),q=u.useRef(null),[I,ze]=u.useState(""),[B,he]=u.useState(null),[Fe,me]=u.useState(null),[Pe,H]=u.useState(!1),[Ve,K]=u.useState(!1),[ee,We]=u.useState(!1),[fe,xe]=u.useState(!1),[ge,pe]=u.useState(!1),[Ue,W]=u.useState(1),[Y,Le]=u.useState(10),O=u.useDeferredValue(f),A=u.useDeferredValue(m),{onWorkOrderCompleted:ve,onMovementsRefreshRequested:ye}=at(),te=u.useMemo(()=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",currencyDisplay:"symbol"}),[]),_e=u.useMemo(()=>new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"short"}),[]),je=u.useMemo(()=>["turtle","lion","giraffe","parrot","alligator","jaguar","elephant","wolf","dolphin","eagle"],[]),qe=o=>{const c=je[Math.floor(Math.random()*je.length)]||"turtle";me(c),he(o)},Be=o=>r?.find(c=>c.movementId===o),z=u.useMemo(()=>({sku:O,workOrder:A,type:y,period:j,customStart:j==="custom"?N:"",customEnd:j==="custom"?I:""}),[O,A,y,j,N,I]),be=()=>{switch(j){case"today":return"Today";case"last7":return"Last 7 days";case"month":return"Current month";case"quarter":return"Current quarter";case"custom":return N&&I?`${N} to ${I}`:"Custom range (incomplete)";default:return j}},$e=()=>{H(!0)},Je=()=>{t&&t(T,z),H(!1)},Ge=()=>{K(!0)},He=()=>{s&&s(T,z),K(!1)},Ke=async()=>{if(l){xe(!0);try{await l()}finally{xe(!1)}}},Ye=async()=>{if(i){pe(!0);try{await i()}catch(o){console.error("Failed to clear history:",o)}finally{pe(!1)}}},[Q,X]=u.useMemo(()=>Nt(j,N,I),[j,N,I]),T=u.useMemo(()=>{const o=[];return(r||[]).forEach((c,g)=>{if(c.type===x.DAMAGE||O&&!c.skuOrName.toLowerCase().includes(O.toLowerCase())||A&&!c.ref.toLowerCase().includes(A.toLowerCase())||y&&c.type!==y)return;const E=c.datetime instanceof Date?c.datetime.getTime():new Date(c.datetime).getTime();E<Q||E>X||o.push([c,g])}),o.sort(([c],[g])=>{const E=c.datetime instanceof Date?c.datetime.getTime():new Date(c.datetime).getTime();return(g.datetime instanceof Date?g.datetime.getTime():new Date(g.datetime).getTime())-E}),o},[r,O,A,y,Q,X]),$=u.useMemo(()=>{const o=T.filter(([g])=>[x.RECEIVE,x.PRODUCE,x.WASTE,x.ADJUSTMENT].includes(g.type));if(ee||!n)return o;const c=n();return o.filter(([g])=>!c.has(g.movementId))},[T,ee,n]),F=u.useMemo(()=>{const o=T.filter(([p])=>[x.RECEIVE,x.PRODUCE,x.WASTE,x.ADJUSTMENT].includes(p.type));if(!n)return{newMovements:o.length,alreadyExported:0};const c=n(),g=o.filter(([p])=>!c.has(p.movementId)).length,E=o.length-g;return{newMovements:g,alreadyExported:E}},[T,n]),we=u.useMemo(()=>{const o=new Map;return(r||[]).forEach(c=>{if(O&&!c.skuOrName.toLowerCase().includes(O.toLowerCase())||A&&!c.ref.toLowerCase().includes(A.toLowerCase())||y&&c.type!==y&&c.type!==x.DAMAGE)return;const g=c.datetime instanceof Date?c.datetime.getTime():new Date(c.datetime).getTime();if(g<Q||g>X||c.type!==x.RECEIVE&&c.type!==x.DAMAGE||!c.ref)return;const E=c.ref.replace(/-REJECTED$/,"").replace(/-DAMAGE$/,"");o.has(E)||o.set(E,{packingSlip:E,totalReceived:0,totalDamaged:0,effectiveQty:0,totalValue:0,damageRate:0,datetime:c.datetime instanceof Date?c.datetime.toISOString():c.datetime,generalNotes:void 0,damageNotes:void 0});const p=o.get(E);c.qty>0?(p.totalReceived+=c.qty,p.totalValue+=c.value,c.notes&&!p.generalNotes&&(p.generalNotes=c.notes)):(p.totalDamaged+=Math.abs(c.qty),c.notes&&!p.damageNotes&&(p.damageNotes=c.notes),c.notes&&!p.generalNotes&&(p.generalNotes=c.notes)),p.effectiveQty=p.totalReceived-p.totalDamaged,p.damageRate=p.totalReceived>0?p.totalDamaged/p.totalReceived*100:0}),o},[r,O,A,y,Q,X]),Qe=(o,c)=>{q.current&&clearTimeout(q.current);const g=o.currentTarget.getBoundingClientRect(),E=window.innerWidth,p=320,h=g.right+15+p>E?g.left-p-15:g.right+15;Re({x:Math.max(10,h),y:g.top+window.scrollY}),V(c)},Xe=()=>{q.current=setTimeout(()=>{V(null)},100)};u.useEffect(()=>{W(1)},[O,A,y,j,N,I]),u.useEffect(()=>()=>{q.current&&clearTimeout(q.current)},[]),u.useEffect(()=>{console.log("üîÑ Setting up Supabase real-time subscription for movements");const o=st.channel("movements_realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"movements"},c=>{console.log("üìù New movement detected via Supabase:",c),a&&(console.log("üîÑ Triggering movements refresh from Supabase subscription"),a())}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"movements"},c=>{console.log("üìù Movement updated via Supabase:",c),a&&(console.log("üîÑ Triggering movements refresh from Supabase update"),a())}).subscribe(c=>{console.log("üì° Movements subscription status:",c)});return()=>{console.log("üîå Unsubscribing from movements real-time"),o.unsubscribe()}},[a]),u.useEffect(()=>{const o=ve(g=>{console.log("üéâ Work Order completed event received:",g.detail),a&&(console.log("üîÑ Triggering movements refresh from work order completion"),a())}),c=ye(g=>{console.log("üîÑ Movements refresh requested by:",g.detail.source),a&&(console.log("üîÑ Triggering movements refresh from explicit request"),a())});return()=>{o(),c()}},[ve,ye,a]);const Z=T.length,U=Math.max(1,Math.ceil(Z/Y)),L=Math.min(Ue,U),se=(L-1)*Y,Ee=se+Y,Ne=T.slice(se,Ee),Se=u.useRef(null),Ce=yt({count:Ne.length,getScrollElement:()=>Se.current,estimateSize:()=>44,overscan:8});return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(ne,{className:"rounded-xl border border-dashed",children:[e.jsx(ie,{className:"py-4",children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4",children:[e.jsxs(re,{className:"text-lg",children:["Last Movements ",e.jsx("span",{className:"text-sm font-normal text-green-600",children:"üöÄ Real-time"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row items-start md:items-center gap-2",children:[e.jsxs(le,{value:j,onValueChange:o=>D(o),children:[e.jsx(ae,{className:"h-8 w-[160px] rounded-xl",children:e.jsx(oe,{placeholder:"Period"})}),e.jsxs(ce,{children:[e.jsx(C,{value:"today",children:"Today"}),e.jsx(C,{value:"last7",children:"Last 7 days"}),e.jsx(C,{value:"month",children:"Current month"}),e.jsx(C,{value:"quarter",children:"Current quarter"}),e.jsx(C,{value:"custom",children:"Custom range"})]})]}),j==="custom"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{type:"date",value:N,onChange:o=>S(o.target.value),className:"h-8 rounded-xl w-36"}),e.jsx("span",{className:"text-slate-500",children:"to"}),e.jsx(G,{type:"date",value:I,onChange:o=>ze(o.target.value),className:"h-8 rounded-xl w-36"})]})]})]})}),e.jsxs(de,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-slate-600",children:["Showing ",T.length," of ",r.length," movements"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(M,{size:"sm",variant:"outline",onClick:$e,disabled:T.length===0,className:"rounded-xl",children:["Export to Excel (",T.length,")"]}),e.jsxs(M,{size:"sm",variant:"outline",onClick:Ge,disabled:$.length===0,className:"rounded-xl bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100",children:["Export Journal (",F.newMovements>0&&F.alreadyExported>0?`${F.newMovements} new`:$.length,")"]}),F.alreadyExported>0&&i&&e.jsx(M,{size:"sm",variant:"outline",onClick:Ye,disabled:ge,className:"rounded-xl text-gray-600 border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",title:"Clear journal export history (creates Excel backup first)",children:ge?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin inline-block w-3 h-3 border border-gray-500 border-t-transparent rounded-full mr-1"}),"Clearing..."]}):e.jsx(e.Fragment,{children:"Clear History"})}),l&&e.jsx(M,{size:"sm",variant:"outline",onClick:Ke,disabled:fe,className:"rounded-xl text-green-600 border-green-300 hover:bg-green-50 disabled:opacity-50 disabled:cursor-not-allowed",title:"Sync journal history with cloud",children:fe?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin inline-block w-3 h-3 border border-green-500 border-t-transparent rounded-full mr-1"}),"Syncing..."]}):e.jsx(e.Fragment,{children:"‚òÅÔ∏è Sync"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsx(G,{placeholder:"Filter by SKU or Name",value:f,onChange:o=>v(o.target.value),className:"h-8 rounded-xl"}),e.jsx(G,{placeholder:"Filter by WO",value:m,onChange:o=>w(o.target.value),className:"h-8 rounded-xl"}),e.jsxs(le,{value:y,onValueChange:k,children:[e.jsx(ae,{className:"h-8 w-full rounded-xl",children:e.jsx(oe,{placeholder:"Movement type"})}),e.jsxs(ce,{children:[e.jsx(C,{value:"",children:"All types"}),e.jsx(C,{value:x.RECEIVE,children:"RECEIVE"}),e.jsx(C,{value:x.ISSUE,children:"MATERIAL USAGE"}),e.jsx(C,{value:x.WASTE,children:"WASTE"}),e.jsx(C,{value:x.PRODUCE,children:"COGS"}),e.jsx(C,{value:x.ADJUSTMENT,children:"ADJUSTMENT"})]})]})]}),e.jsx("div",{ref:Se,className:"max-h-96 overflow-auto rounded-md border",children:e.jsxs(nt,{className:"w-full",children:[e.jsx("caption",{className:"sr-only",children:"Last Movements ‚Äì filtered and paginated list"}),e.jsx(it,{children:e.jsxs(J,{children:[e.jsx(P,{scope:"col",children:"Date/Time"}),e.jsx(P,{scope:"col",children:"Type"}),e.jsx(P,{scope:"col",children:"SKU / Output name"}),e.jsx(P,{scope:"col",children:"Qty"}),e.jsx(P,{scope:"col",children:"Value"}),e.jsx(P,{scope:"col",children:"Ref"}),e.jsx(P,{scope:"col",children:"Actions"})]})}),e.jsx(rt,{children:T.length===0?e.jsx(J,{children:e.jsx(R,{colSpan:7,className:"text-sm text-slate-500",children:f||m||y||j!=="last7"||N||I?"No movements match the current filters.":"No movements yet."})}):(()=>{const o=Ce.getVirtualItems(),c=o[0]?.start??0,g=o[o.length-1],E=Ce.getTotalSize()-(g?.end??0);return e.jsxs(e.Fragment,{children:[c>0&&e.jsx(J,{"aria-hidden":!0,style:{height:c},children:e.jsx(R,{colSpan:7})}),o.map(p=>{const[h,St]=Ne[p.index],Ze=`${h.ref}|${h.datetime}|${h.type}|${h.skuOrName}`;return e.jsxs(J,{"data-index":p.index,...h.type===x.RECEIVE&&h.ref?{onMouseEnter:et=>Qe(et,h.ref),onMouseLeave:Xe,className:"cursor-help hover:bg-slate-50"}:{},children:[e.jsx("th",{scope:"row",className:"px-4 py-2 text-left font-normal",children:_e.format(h.datetime instanceof Date?h.datetime:new Date(h.datetime))}),e.jsx(R,{children:e.jsx(lt,{variant:bt(h.type),children:h.type===x.PRODUCE?"COGS":h.type===x.ISSUE?"MATERIAL USAGE":h.type})}),e.jsx(R,{children:h.skuOrName}),e.jsx(R,{children:h.type===x.RECEIVE?h.qty>0?`+${h.qty}`:h.qty:h.type===x.ADJUSTMENT?h.qty>0?`+${h.qty}`:h.qty:Math.abs(h.qty)}),e.jsx(R,{className:h.type===x.RECEIVE||h.type===x.ADJUSTMENT?h.value>0?"text-green-600":"text-red-600":"",children:h.type===x.RECEIVE||h.type===x.ADJUSTMENT?te.format(h.value):te.format(Math.abs(h.value))}),e.jsx(R,{children:h.ref}),e.jsx(R,{children:h.type===x.PRODUCE&&d&&e.jsx(Et,{movementId:h.movementId,movementType:h.type,onDelete:()=>qe(h.movementId)})})]},Ze)}),E>0&&e.jsx(J,{"aria-hidden":!0,style:{height:E},children:e.jsx(R,{colSpan:7})})]})})()})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-3 pt-2",children:[e.jsxs("div",{className:"text-sm text-slate-600",children:["Showing ",Z===0?0:se+1,"-",Math.min(Ee,Z)," of ",Z]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(le,{value:String(Y),onValueChange:o=>{Le(Number(o)),W(1)},children:[e.jsx(ae,{className:"h-9 w-[110px]",children:e.jsx(oe,{placeholder:"Page size"})}),e.jsxs(ce,{children:[e.jsx(C,{value:"10",children:"10 / page"}),e.jsx(C,{value:"25",children:"25 / page"}),e.jsx(C,{value:"50",children:"50 / page"}),e.jsx(C,{value:"100",children:"100 / page"})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(M,{variant:"outline",size:"sm",onClick:()=>W(1),disabled:L===1,children:"¬´"}),e.jsx(M,{variant:"outline",size:"sm",onClick:()=>W(o=>Math.max(1,o-1)),disabled:L===1,children:"Prev"}),e.jsxs("span",{className:"text-sm px-2",children:["Page ",L," / ",U]}),e.jsx(M,{variant:"outline",size:"sm",onClick:()=>W(o=>Math.min(U,o+1)),disabled:L===U,children:"Next"}),e.jsx(M,{variant:"outline",size:"sm",onClick:()=>W(U),disabled:L===U,children:"¬ª"})]})]})]})]})]}),Pe&&e.jsxs("div",{className:"fixed inset-0 z-50",role:"dialog","aria-modal":"true",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:()=>H(!1)}),e.jsx("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[min(100%,500px)]",children:e.jsxs(ne,{className:"rounded-2xl shadow-2xl bg-white",children:[e.jsx(ie,{className:"py-4",children:e.jsx(re,{className:"text-lg",children:"Export Movements to Excel"})}),e.jsxs(de,{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-slate-600",children:["You're about to export ",e.jsxs("strong",{children:[T.length," movement records"]})," to Excel with the following filters applied:"]}),e.jsxs("div",{className:"bg-slate-50 p-3 rounded-lg space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-slate-700",children:"Active Filters:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Period:"})," ",be()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"SKU/Name:"})," ",z.sku||"All"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Work Order:"})," ",z.workOrder||"All"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Movement Type:"})," ",z.type||"All"]})]})]}),e.jsx("p",{className:"text-xs text-slate-500",children:"The exported file will contain: Date, Time, Type, SKU/Product, Quantity, Value, and Reference columns."})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 p-4 border-t",children:[e.jsx(M,{variant:"outline",onClick:()=>H(!1),children:"Cancel"}),e.jsxs(M,{onClick:Je,children:["Export ",T.length," Records"]})]})]})})]}),Ve&&e.jsxs("div",{className:"fixed inset-0 z-50",role:"dialog","aria-modal":"true",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:()=>K(!1)}),e.jsx("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[min(100%,600px)]",children:e.jsxs(ne,{className:"rounded-2xl shadow-2xl bg-white",children:[e.jsx(ie,{className:"py-4",children:e.jsxs(re,{className:"text-lg flex items-center gap-2",children:[e.jsx("span",{className:"text-blue-600",children:"üìä"}),"Export Journal to Excel"]})}),e.jsxs(de,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm text-slate-600",children:["You're about to export ",e.jsxs("strong",{children:[$.length," movements"]})," as journal entries to Excel. This will create ",e.jsxs("strong",{children:[$.length*2," journal lines"]})," (2 per movement)."]}),e.jsxs("div",{className:"bg-slate-50 p-3 rounded-lg space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-slate-700",children:"Export Status:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"text-green-600",children:[e.jsx("span",{className:"font-medium",children:"New entries:"})," ",F.newMovements]}),e.jsxs("div",{className:"text-amber-600",children:[e.jsx("span",{className:"font-medium",children:"Already exported:"})," ",F.alreadyExported]})]}),F.alreadyExported>0&&e.jsx("div",{className:"mt-3 pt-2 border-t border-slate-200",children:e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:ee,onChange:o=>We(o.target.checked),className:"rounded border-gray-300"}),e.jsx("span",{className:"text-xs text-slate-600",children:"Include already exported entries"})]})})]})]}),e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-blue-700",children:"Active Filters:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Period:"})," ",be()]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"SKU/Name:"})," ",z.sku||"All"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Work Order:"})," ",z.workOrder||"All"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Movement Type:"})," ",z.type||"All"]})]})]}),e.jsxs("div",{className:"bg-green-50 p-3 rounded-lg space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-green-700",children:"Journal Structure:"}),e.jsxs("div",{className:"text-xs text-green-600 space-y-1",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"RECEIVE:"})," Debit Inventory, Credit Accounts Payable"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"COGS:"})," Debit COGS, Credit Inventory"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"WASTE:"})," Debit Shrinkage Expense, Credit Inventory"]})]})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 pt-2",children:[e.jsx(M,{variant:"outline",onClick:()=>K(!1),children:"Cancel"}),e.jsxs(M,{onClick:He,className:"bg-blue-600 hover:bg-blue-700 text-white",children:["Export Journal (",$.length*2," lines)"]})]})]})]})})]}),e.jsx(jt,{open:B!==null,onOpenChange:o=>{o||(he(null),me(null))},title:"Delete Movement",description:e.jsx(e.Fragment,{children:B!==null&&e.jsx("span",{className:"text-sm text-slate-600",children:Be(B)?.type===x.PRODUCE?"This will permanently delete the COGS movement and all related WASTE and MATERIAL USAGE movements, restoring stock with FIFO integrity.":"This will permanently delete the RECEIVE movement and restore stock with FIFO integrity."})}),tokenLabel:"Animal",token:Fe||"",inputPlaceholder:"Type the animal exactly as shown",confirmLabel:"Delete",cancelLabel:"Cancel",onConfirm:()=>{B!==null&&d?.(B)}}),b&&we.has(b)&&e.jsx("div",{className:"fixed z-50 bg-white border border-gray-200 rounded-lg shadow-xl p-4 w-80 pointer-events-none",style:{left:ue.x,top:ue.y,transform:"translateY(-50%)"},children:(()=>{const o=we.get(b),c=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),g=new Intl.DateTimeFormat("en-US",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1});return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx("span",{children:"üì¶"}),"Receiving: ",o.packingSlip]}),e.jsxs("div",{className:"border-t border-gray-200 pt-2 space-y-1.5 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("span",{children:"üìÖ"}),g.format(new Date(o.datetime))]}),e.jsxs("div",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx("span",{children:"üìä"}),e.jsxs("span",{children:["Received: ",e.jsx("strong",{children:o.totalReceived})," units",o.totalDamaged>0&&e.jsxs("span",{className:"text-red-600",children:[" ‚Üí ",o.effectiveQty," units"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-gray-700",children:[e.jsx("span",{children:"üí∞"}),"Value: ",e.jsx("strong",{children:c.format(o.totalValue)})]}),o.totalDamaged>0&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600",children:[e.jsx("span",{children:"‚ö†Ô∏è"}),"Damage: ",e.jsx("strong",{children:o.totalDamaged})," units (",o.damageRate.toFixed(1),"%)"]}),(o.generalNotes||o.damageNotes)&&e.jsxs("div",{className:"border-t border-gray-200 pt-2 mt-2 space-y-2",children:[o.generalNotes&&e.jsxs("div",{className:"flex items-start gap-2 text-gray-600",children:[e.jsx("span",{className:"mt-0.5",children:"üìù"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-xs text-gray-500 uppercase tracking-wide",children:"General Notes:"}),e.jsx("div",{className:"text-sm text-gray-700 whitespace-pre-wrap break-words",children:o.generalNotes})]})]}),o.damageNotes&&e.jsxs("div",{className:"flex items-start gap-2 text-red-600",children:[e.jsx("span",{className:"mt-0.5",children:"‚ö†Ô∏è"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-xs text-red-500 uppercase tracking-wide",children:"Damage Notes:"}),e.jsx("div",{className:"text-sm text-red-700 whitespace-pre-wrap break-words",children:o.damageNotes})]})]})]})]})]})})()})]})}export{Tt as default};
